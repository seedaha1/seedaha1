<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لعبة صيدها - الذاكرة العائلية</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e6f7ff;
            color: #222;
            text-align: center;
            padding: 20px;
            direction: rtl;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden; /* لمنع ظهور شريط التمرير الأفقي */
            position: relative;
            box-sizing: border-box; /* لضمان عدم تجاوز البادينج للحجم */
        }

        /* الملاحظة القانونية */
        .legal-notice {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffe0b2;
            color: #8d6e63;
            padding: clamp(5px, 2vw, 15px) clamp(10px, 3vw, 20px);
            font-size: clamp(0.7em, 1.5vw, 14px);
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-bottom: 1px solid #d7ccc8;
            line-height: 1.5;
            text-align: center;
            box-sizing: border-box;
        }
        .legal-notice span {
            display: block;
            margin-top: clamp(3px, 1vw, 5px);
            font-style: italic;
            font-weight: normal;
        }

        /* نافذة المودال */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
            box-sizing: border-box;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
            display: flex;
        }

        .modal-content {
            background-color: #ffffff;
            padding: clamp(20px, 5vw, 30px);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            text-align: center;
            line-height: 1.6;
            animation: fadeIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
            color: #333;
            box-sizing: border-box;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            color: #007bff;
            margin-bottom: clamp(15px, 3vw, 20px);
            font-size: clamp(1.5em, 4vw, 2em);
        }

        .modal-content ul {
            list-style: none;
            padding: 0;
            margin: clamp(15px, 3vw, 20px) 0;
        }

        .modal-content ul li {
            margin-bottom: clamp(8px, 2vw, 10px);
            font-size: clamp(0.9em, 2.5vw, 1.1em);
            text-align: right;
            padding-right: clamp(5px, 2vw, 10px);
            border-right: 3px solid #007bff;
        }

        .modal-content p {
            font-size: clamp(0.9em, 2.5vw, 1.1em);
            margin-top: clamp(20px, 4vw, 25px);
            font-weight: bold;
            color: #555;
        }
        .modal-content .button-group {
            margin-top: clamp(20px, 4vw, 30px);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: clamp(10px, 2vw, 15px);
        }
        .modal-content button {
            background-color: #004080;
            color: white;
            border: none;
            padding: clamp(12px, 3vw, 18px) clamp(25px, 6vw, 35px);
            border-radius: 8px;
            font-size: clamp(1em, 2.8vw, 1.3em);
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0; /* Managed by button-group gap */
        }
        .modal-content button:hover {
            background-color: #003366;
        }

        /* شاشة اختيار الفرق */
        #teamSelectionModal .team-options {
            display: flex;
            justify-content: center;
            gap: clamp(15px, 4vw, 20px);
            margin-top: clamp(20px, 4vw, 30px);
            flex-wrap: wrap;
        }
        #teamSelectionModal .team-options button {
            font-size: clamp(1em, 2.8vw, 1.3em);
            padding: clamp(12px, 3vw, 18px) clamp(25px, 6vw, 35px);
        }

        /* شاشة تسمية الفرق */
        #teamNameInputModal .team-name-inputs {
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 2vw, 15px);
            margin-top: clamp(15px, 3vw, 20px);
        }
        #teamNameInputModal .team-name-inputs div {
            display: flex;
            flex-direction: column; /* Stack label and input on small screens */
            align-items: flex-start; /* Align label to start */
            gap: clamp(5px, 1vw, 10px);
        }
        @media (min-width: 480px) { /* Adjust for wider mobile screens */
            #teamNameInputModal .team-name-inputs div {
                flex-direction: row; /* Side by side on wider screens */
                align-items: center;
            }
        }
        #teamNameInputModal .team-name-inputs label {
            font-weight: bold;
            min-width: 80px;
            text-align: right;
            color: #007bff;
            font-size: clamp(0.9em, 2.2vw, 1em);
        }
        #teamNameInputModal .team-name-inputs input[type="text"] {
            flex-grow: 1;
            padding: clamp(8px, 2vw, 12px);
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: clamp(0.9em, 2.2vw, 1.1em);
            text-align: right;
            width: 100%; /* Ensure input takes full width */
            box-sizing: border-box;
        }
        #teamNameInputModal .team-name-inputs input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }


        /* الواجهة الرئيسية للعبة */
        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 1000px; /* زيادة عرض المنطقة لتناسب المربعات الأكبر على الشاشات الكبيرة */
            padding: 0 clamp(10px, 2vw, 20px);
            box-sizing: border-box;
        }

        .scoreboard {
            display: flex;
            justify-content: center;
            gap: clamp(10px, 3vw, 20px);
            margin: clamp(15px, 3vw, 20px) 0 clamp(8px, 2vw, 10px);
            flex-wrap: wrap;
            width: 100%; /* Ensure scoreboard takes full width */
        }

        .team {
            padding: clamp(8px, 2.5vw, 12px) clamp(15px, 4vw, 20px);
            border-radius: 12px;
            background: #e0f7fa;
            font-weight: bold;
            font-size: clamp(0.9em, 2.5vw, 1.1em);
            min-width: clamp(90px, 20vw, 120px);
            border: 3px solid transparent;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        .team span {
            font-size: clamp(1.4em, 4vw, 1.8em);
            margin-top: 5px;
            color: #004085;
        }

        /* ألوان الفرق */
        .blue { background-color: #cce5ff; color: #004085; }
        .red { background-color: #f8d7da; color: #721c24; }
        .green { background-color: #d4edda; color: #155724; }
        .orange { background-color: #fff3cd; color: #856404; }

        /* تمييز الفريق الذي عليه الدور */
        .team.active {
            border-color: #007bff;
            box-shadow: 0 0 12px rgba(0, 123, 255, 0.6);
            transform: translateY(-5px);
        }

        .controls {
            margin: clamp(15px, 3vw, 20px) 0;
            display: flex;
            justify-content: center;
            gap: clamp(10px, 2.5vw, 15px);
            flex-wrap: wrap;
            width: 100%;
        }

        .controls button {
            background-color: #004080;
            color: white;
            border: none;
            padding: clamp(12px, 3vw, 18px) clamp(25px, 6vw, 35px);
            border-radius: 10px;
            font-size: clamp(1em, 2.8vw, 1.3em);
            margin: 0;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }

        .controls button:hover {
            background-color: #003366;
            transform: translateY(-2px);
        }

        .controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .timer {
            font-size: clamp(20px, 5vw, 28px);
            font-weight: bold;
            margin-bottom: clamp(10px, 2.5vw, 15px);
            color: #333;
            min-height: 35px;
        }

        /* التخطيط الافتراضي للشبكة */
        .grid {
            display: grid;
            grid-gap: clamp(10px, 2.5vw, 20px);
            justify-content: center;
            margin: clamp(15px, 3vw, 20px) auto;
            max-width: fit-content;
            width: 100%; /* ليتكيف مع الشاشات الصغيرة */
            box-sizing: border-box;
        }

        /* أحجام الخلايا الافتراضية */
        .cell {
            border-radius: 15px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, filter 0.3s ease;
            user-select: none;
            color: #222;
            text-align: center;
            line-height: 1.2;
            padding: 5px;
            box-sizing: border-box;
        }
        .cell:not(.matched):not(.empty):hover {
            transform: scale(1.05);
        }

        /* الخلايا الفارغة */
        .cell.empty {
            background-color: transparent;
            box-shadow: none;
            cursor: default;
            pointer-events: none;
        }

        .cell.hidden {
            background-color: #0055AA;
            color: transparent;
            cursor: pointer;
        }

        .cell.matched {
            background-color: #a3cfbb;
            cursor: default;
            pointer-events: none;
            transform: none;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
        }

        /* نمط خاص لبطاقة +/- 1 عند الكشف عنها في مرحلة اللعب */
        .cell.value-revealed {
            font-weight: bold;
            font-size: clamp(2.5em, 8vw, 4em); /* Adjust font size for responsiveness */
            transform: none;
            color: white !important;
        }
        .cell.value-revealed.negative {
            background-color: #dc3545;
        }
        .cell.value-revealed.positive {
            background-color: #28a745;
        }

        /* أحجام الشبكة حسب الجولة */
        /* جولات 15 مربعًا -> تخطيط 3x5 */
        .grid.size-15 {
            grid-template-columns: repeat(auto-fit, minmax(clamp(80px, 18vw, 140px), 1fr)); /* Responsive grid */
            grid-template-rows: auto;
        }
        .grid.size-15 .cell {
            width: auto; /* Let auto-fit handle width */
            height: clamp(80px, 18vw, 140px);
            aspect-ratio: 1 / 1; /* Keep aspect ratio square */
        }

        /* جولات 18 مربعًا -> تخطيط 3x6 */
        .grid.size-18 {
            grid-template-columns: repeat(auto-fit, minmax(clamp(70px, 15vw, 110px), 1fr)); /* Responsive grid */
            grid-template-rows: auto;
        }
        .grid.size-18 .cell {
            width: auto; /* Let auto-fit handle width */
            height: clamp(70px, 15vw, 110px);
            aspect-ratio: 1 / 1; /* Keep aspect ratio square */
        }

        /* نمط خاص للخلايا التي تحتوي على نصوص أو أرقام حسابية */
        .cell.text-content {
            font-size: clamp(20px, 4.5vw, 35px);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: normal;
            word-break: break-word;
        }

        /* تعديلات محددة للخط لجولات الكلمات والمرادفات/الأضداد والعمليات الحسابية */
        .cell[data-round-type="words"],
        .cell[data-round-type="math"],
        .cell[data-round-type="letter-word"],
        .cell[data-round-type="incomplete-word"] {
            font-size: clamp(18px, 4vw, 30px);
        }
        /* تعديل خاص لحجم خط الإيموجي والنجمة */
        .cell[data-round-type="emoji"],
        .cell[data-special-type="star-placeholder"] {
            font-size: clamp(30px, 6vw, 45px);
        }


        /* مكان وتصميم رسالة "دور الفريق" */
        .result {
            margin-top: clamp(8px, 2vw, 10px);
            margin-bottom: clamp(15px, 3vw, 20px);
            font-size: clamp(18px, 4vw, 24px);
            font-weight: bold;
            color: #007bff;
            min-height: 30px;
        }

        /* تأثير الحروف العربية المتساقطة */
        .falling-letter {
            position: absolute;
            top: -50px;
            font-size: clamp(1.5em, 5vw, 2.5em);
            color: rgba(0, 51, 102, 0.3);
            animation: fall linear infinite;
            pointer-events: none;
            user-select: none;
            opacity: 0;
            z-index: -1;
        }

        @keyframes fall {
            0% { transform: translateY(-50px) translateX(0) scale(0.8); opacity: 0; }
            10% { opacity: 0.7; }
            90% { opacity: 0; }
            100% { transform: translateY(100vh) translateX(0) scale(1.2); opacity: 0; }
        }

        /* شاشة العد التنازلي الفخمة */
        #countdownOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: clamp(3em, 8vw, 5em);
            font-weight: bold;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        #countdownOverlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        #countdownText {
            margin-bottom: clamp(10px, 3vw, 20px);
            font-size: 0.5em;
            text-align: center;
        }

        #countdownNumber {
            font-size: 2em;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.1); opacity: 0.8; }
        }

        /* شاشة الفوز النهائية */
        #finalWinnerModal {
            color: white;
            z-index: 4000;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
        }

        #finalWinnerModal h2 {
            font-size: clamp(2.5em, 8vw, 4em);
            margin-bottom: clamp(20px, 5vw, 30px);
            color: #ffd700;
            text-shadow: 3px 3px 10px rgba(255,165,0,0.8);
        }
        #finalWinnerModal p {
            font-size: clamp(1.2em, 4vw, 2em);
            margin-bottom: clamp(25px, 6vw, 40px);
        }

        #finalWinnerModal button {
            padding: clamp(15px, 4vw, 20px) clamp(30px, 8vw, 40px);
            font-size: clamp(1.2em, 3.5vw, 1.5em);
        }

        /* تأثير القصاصات */
        .confetti {
            position: absolute;
            width: clamp(5px, 2vw, 10px);
            height: clamp(5px, 2vw, 10px);
            background-color: #f00;
            animation: fallConfetti 5s linear forwards;
            opacity: 0;
            border-radius: 50%;
        }

        @keyframes fallConfetti {
            0% { transform: translateY(-100px) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(120vh) rotateZ(720deg); opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="legal-notice">
        ملاحظة: هذه النسخة لشخص واحد فقط وغير قابلة للنشر أو البيع. ومن يخالف ذلك سيتم اتخاذ الإجراءات القانونية في هذا الأمر.
        <span>وللتذكير بذمتك وأمانتك: "قال ﷺ: لا إيمان لمن لا أمانة له، ولا دين لمن لا عهد له"</span>
    </div>

    <div id="countdownOverlay" class="modal-overlay"> <div id="countdownText"></div>
        <div id="countdownNumber"></div>
    </div>

    <div id="finalWinnerModal" class="modal-overlay"> <div class="modal-content">
            <h2 id="finalWinnerText"></h2>
            <p id="finalTieText"></p>
            <div class="button-group">
                <button id="playAgainBtn">إعادة تعيين وبدء لعبة جديدة</button>
                <button id="startTieBreakerBtn" style="display: none;">بدء جولة التعادل</button>
            </div>
        </div>
    </div>


    <div class="modal-overlay" id="adviceModal"> <div class="modal-content">
            <h2>نصيحة علشان نلعب ونستانس… بس بدون ما ننسى الأهم 🌙</h2>
            <ul>
                <li>⏰ "اللعب ممتع، بس خلّه بعد الصلاة، عشان ما تضيع عليك لا متعة ولا أجر."</li>
                <li>📖 "اللعبة حلوة، بس القرآن أحلى، خذ لك وقت بين الجولات وارتّح مع كلام الله."</li>
                <li>🙏 "إذا جاء وقت الصلاة، نوقف اللعب ونكسب رضا رب العالمين."</li>
                <li>✋ "نلعب ونضحك، لكن ما نخلي اللعب يلهينا عن طاعة الله."</li>
                <li>📚 "اللعبة جزء من يومنا، مو كل يومنا… لا تنسى أهدافك وطموحاتك."</li>
                <li>🎯 "اللعبة ما تمنع إنك تذاكر، نظّم وقتك وخلّ اللعب مكافأة بعد الإنجاز."</li>
                <li>⌛ "وقت المذاكرة غالي، لا تخليه يضيع على حساب جيم ممكن تلعبه بأي وقت."</li>
            </ul>
            <p>"إذا لعبت وأنت محافظ على صلاتك وأذكارك وقراءة القرآن وخلصت المذاكرة والأشغال اللي عليك… أنت كسبت الدنيا والآخرة بإذن الله"</p>
            <div class="button-group">
                <button onclick="showInstructionsModal()">التالي</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="instructionsModal"> <div class="modal-content">
            <h2>📝 تعليمات لعبة صيدها 🎮</h2>
            <ul>
                <li>🌟 **الهدف:** مطابقة الرموز أو الكلمات أو العمليات الحسابية المتشابهة في خلايا الشبكة.</li>
                <li>1️⃣ **اختيار الفئة:** (ملاحظة: يتم اختيار الفئة تلقائيًا بالترتيب في هذه اللعبة).</li>
                <li>2️⃣ **بدء الجولة:** اضغط زر **بدء الجولة** لعرض الرموز على الشبكة لمدة محددة ⏳ مع عداد يظهر الوقت. خلال هذه الفترة، حاول تذكر أماكن الرموز.</li>
                <li>3️⃣ **مطابقة الرموز:** بعد انتهاء الوقت ⏰، تعود الخلايا لأرقام فقط، ابدأ بالنقر على خليتين:
                    <ul>
                        <li>✅ إذا تطابق الرمزان، يكسب الفريق أو اللاعبين نقطة على كل تطابق صحيح.</li>
                        <li>❌ إذا لم تتطابق، لا يكسب أي نقطة.</li>
                    </ul>
                </li>
                <li>4️⃣ **بطاقة النجمة ⭐:** إذا كشفت بطاقة **النجمة ⭐**، سيتم إضافة أو خصم نقاط من رصيد فريقك! (تتغير قيمتها عشوائياً بين سالب وموجب وتزيد مع كل مجموعة جولات، ويمكن إعادة فتحها!).</li>
                <li>5️⃣ **انتهاء الجولة:** عند الكشف عن كل **أزواج الرموز العادية**، ستكون الجولة قد انتهت. اللعبة ستنتقل تلقائيًا إلى الجولة التالية داخل المجموعة.</li>
                <li>6️⃣ **الانتقال للمجموعة التالية:** بعد انتهاء جميع جولات المجموعة، سيظهر زر **"المجموعة التالية"** للانتقال يدويًا.</li>
                <li>🔄 **زر إعادة تعيين:** يعيد اللعبة للحالة الابتدائية لتختار عدد الفرق أو تعيد الجولة.</li>
            </ul>
            <div class="button-group">
                <button onclick="hideInstructionsAndShowTeamSelection()">بدء اللعبة</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="teamSelectionModal"> <div class="modal-content">
            <h2>اختر عدد الفرق</h2>
            <div class="team-options">
                <button onclick="selectTeams(2)">2 فرق</button>
                <button onclick="selectTeams(3)">3 فرق</button>
                <button onclick="selectTeams(4)">4 فرق</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="teamNameInputModal"> <div class="modal-content">
            <h2>سمِّ الفرق</h2>
            <div class="team-name-inputs" id="teamNameInputsContainer">
                </div>
            <div class="button-group">
                <button onclick="confirmTeamNames()">تأكيد الأسماء</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resetConfirmationModal">
        <div class="modal-content">
            <h2>هل أنت متأكد؟</h2>
            <p>هل تريد إعادة تعيين اللعبة وبدء من جديد؟ ستفقد جميع النقاط الحالية.</p>
            <div class="button-group">
                <button id="confirmResetBtn">تأكيد</button>
                <button id="cancelResetBtn">إلغاء</button>
            </div>
        </div>
    </div>

    <div class="game-area">
        <div class="scoreboard" id="scoreboard">
            </div>

        <div class="result" id="result"></div>

        <div class="timer" id="timerContainer"></div>

        <div class="grid" id="grid"></div>

        <div class="controls">
            <button onclick="handleStartOrNextRound()" id="startGameBtn">بدء الجولة</button>
            <button onclick="nextGroupManually()" id="nextGroupBtn" style="display: none;">المجموعة التالية</button>
            <button onclick="showResetConfirmation()" id="resetGameBtn">إعادة تعيين</button>
        </div>
    </div>

    <script>
        // تعريف فئات الجولات (محدثة)
        const roundCategories = [
            "فواكه", "خضروات", "الأدوات", "المركبات", // المجموعة الأولى
            "الحرف والكلمة", "أكمل الكلمة", "مرادف الكلمة", "الكلمة وعكسها", // المجموعة الثانية
            "عملية جمع", "عملية طرح", "عملية ضرب", "عملية قسمة" // المجموعة الثالثة
        ];

        // المجموعة الأولى
        const group1Rounds = [
            { emojis: ["🍎", "🍌", "🍇", "🍊", "🍓", "🍍", "🥭", "🥝"], gridSizeClass: "size-18", timer: 10, category: roundCategories[0], specialSquaresCount: 2, totalEmojiPairs: 8, type: "emoji" },
            { emojis: ["🥕", "🥔", "🧅", "🥦", "🥒", "🌶️", "🍆", "🌽"], gridSizeClass: "size-18", timer: 10, category: roundCategories[1], specialSquaresCount: 2, totalEmojiPairs: 8, type: "emoji" },
            { emojis: ["🔨", "🔧", "💡", "✂️", "📌", "🔑", "🔋", "📱"], gridSizeClass: "size-18", timer: 5, category: roundCategories[2], specialSquaresCount: 2, totalEmojiPairs: 8, type: "emoji" },
            { emojis: ["🚗", "🚌", "🚲", "🚆", "🚁", "🚤", "🛵", "🚢"], gridSizeClass: "size-18", timer: 5, category: roundCategories[3], specialSquaresCount: 2, totalEmojiPairs: 8, type: "emoji" }
        ];

        // المجموعة الثانية
        const group2Rounds = [
            { letterWordPairs: [["أ", "أسد"], ["ب", "بقرة"], ["ت", "تمساح"], ["ج", "جمل"], ["ح", "حصان"], ["د", "دب"], ["ز", "زرافة"]], gridSizeClass: "size-15", timer: 10, category: roundCategories[4], specialSquaresCount: 1, totalEmojiPairs: 7, type: "letter-word" },
            { incompleteWordPairs: [["كتاب", "كت_ب", "ا"], ["قلم", "ق_م", "ل"], ["شمس", "ش_س", "م"], ["قمر", "ق_ر", "م"], ["بحر", "ب_ر", "ح"], ["وردة", "ور_ة", "د"], ["تفاح", "ت_اح", "ف"]], gridSizeClass: "size-15", timer: 10, category: roundCategories[5], specialSquaresCount: 1, totalEmojiPairs: 7, type: "incomplete-word" },
            { textPairs: [["سعيد", "فرح"], ["كبير", "ضخم"], ["صغير", "ضئيل"], ["سريع", "عاجل"], ["بطيء", "متباطئ"], ["جميل", "حلو"], ["ذكي", "عبقري"]], gridSizeClass: "size-15", timer: 5, category: roundCategories[6], specialSquaresCount: 1, totalEmojiPairs: 7, type: "words" },
            { textPairs: [["صغير", "كبير"], ["قريب", "بعيد"], ["طويل", "قصير"], ["حار", "بارد"], ["ليل", "نهار"], ["صعود", "هبوط"], ["داخل", "خارج"]], gridSizeClass: "size-15", timer: 5, category: roundCategories[7], specialSquaresCount: 1, totalEmojiPairs: 7, type: "words" }
        ];

        // المجموعة الثالثة (العمليات الحسابية)
        const group3Rounds = [
            { mathPairs: [["2+3", "5"], ["5+4", "9"], ["10+2", "12"], ["7+1", "8"], ["6+6", "12"], ["9+3", "12"], ["4+7", "11"]], gridSizeClass: "size-15", timer: 15, category: roundCategories[8], specialSquaresCount: 1, totalEmojiPairs: 7, type: "math" },
            { mathPairs: [["8-2", "6"], ["7-3", "4"], ["10-5", "5"], ["9-1", "8"], ["12-4", "8"], ["11-6", "5"], ["15-7", "8"]], gridSizeClass: "size-15", timer: 15, category: roundCategories[9], specialSquaresCount: 1, totalEmojiPairs: 7, type: "math" },
            { mathPairs: [["2*3", "6"], ["4*2", "8"], ["5*5", "25"], ["3*7", "21"], ["6*4", "24"], ["8*3", "24"], ["7*5", "35"]], gridSizeClass: "size-15", timer: 15, category: roundCategories[10], specialSquaresCount: 1, totalEmojiPairs: 7, type: "math" },
            { mathPairs: [["10/2", "5"], ["12/3", "4"], ["15/5", "3"], ["18/6", "3"], ["20/4", "5"], ["24/8", "3"], ["28/7", "4"]], gridSizeClass: "size-15", timer: 15, category: roundCategories[11], specialSquaresCount: 1, totalEmojiPairs: 7, type: "math" }
        ];

        let allGameRounds = [group1Rounds, group2Rounds, group3Rounds];
        const tieBreakerEmojis = [
            "505", "515", "525", "535", "545", "555", "575"
        ];
        const tieBreakerTimer = 5;
        const tieBreakerSpecialSquaresCount = 1;
        const tieBreakerFixedValue = 4;
        const tieBreakerTotalEmojiPairs = 7;

        const interRoundDelay = 10;

        let teamNames = {
            "blue": "الفريق الأزرق",
            "red": "الفريق الأحمر",
            "green": "الفريق الأخضر",
            "orange": "الفريق البرتقالي"
        };
        const teamColors = ["blue", "red", "green", "orange"];
        const teamCssColors = {
            "blue": "#004085",
            "red": "#721c24",
            "green": "#155724",
            "orange": "#856404"
        };
        let activeTeams = [];
        let currentTeamIndex = 0;
        let startingTeamIndexForRound = 0;

        let currentGroupIndex = 0;
        let roundIndex = 0;

        let board = [];
        let firstPick = null;
        let lockBoard = false;
        let scores = {};
        let matchedPairsCount = 0;
        let timerInterval = null;
        let isTieBreakerRound = false;
        let gameInitialized = false;
        let isTransitioning = false;

        const adviceModal = document.getElementById("adviceModal");
        const instructionsModal = document.getElementById("instructionsModal");
        const teamSelectionModal = document.getElementById("teamSelectionModal");
        const teamNameInputModal = document.getElementById("teamNameInputModal");
        const teamNameInputsContainer = document.getElementById("teamNameInputsContainer");
        const gameArea = document.querySelector(".game-area");

        const grid = document.getElementById("grid");
        const timerContainer = document.getElementById("timerContainer");
        const resultDisplay = document.getElementById("result");
        const startGameBtn = document.getElementById("startGameBtn");
        const nextGroupBtn = document.getElementById("nextGroupBtn");
        const resetGameBtn = document.getElementById("resetGameBtn");
        const scoreboardDiv = document.getElementById("scoreboard");
        let scoreBoardElements = {};

        const countdownOverlay = document.getElementById("countdownOverlay");
        const countdownText = document.getElementById("countdownText");
        const countdownNumber = document.getElementById("countdownNumber");

        const finalWinnerModal = document.getElementById("finalWinnerModal");
        const finalWinnerText = document.getElementById("finalWinnerText");
        const finalTieText = document.getElementById("finalTieText");
        const playAgainBtn = document.getElementById("playAgainBtn");
        const startTieBreakerBtn = document.getElementById("startTieBreakerBtn");

        const resetConfirmationModal = document.getElementById("resetConfirmationModal");
        const confirmResetBtn = document.getElementById("confirmResetBtn");
        const cancelResetBtn = document.getElementById("cancelResetBtn");

        const arabicLetters = ['ا', 'ب', 'ت', 'ث', 'ج', 'ح', 'خ', 'د', 'ذ', 'ر', 'ز', 'س', 'ش', 'ص', 'ض', 'ط', 'ظ', 'ع', 'غ', 'ف', 'ق', 'ك', 'ل', 'م', 'ن', 'ه', 'و', 'ي'];
        const confettiColors = ["#f44336", "#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4", "#009688", "#4CAF50", "#8BC34A", "#CDDC39", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722", "#795548", "#9E9E9E", "#607D8B"];

        function createFallingLetter() {
            const letter = document.createElement('span');
            letter.textContent = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
            letter.classList.add('falling-letter');
            letter.style.left = `${Math.random() * 100}vw`;
            letter.style.animationDuration = `${Math.random() * 8 + 5}s`;
            letter.style.animationDelay = `${Math.random() * 5}s`;
            document.body.appendChild(letter);
            letter.addEventListener('animationend', () => {
                letter.remove();
                createFallingLetter();
            });
        }

        for (let i = 0; i < 20; i++) {
            createFallingLetter();
        }

        function showAdviceModal() {
            adviceModal.classList.add('show');
            gameArea.style.display = 'none';
            finalWinnerModal.classList.remove('show');
            clearConfetti();
        }

        function showInstructionsModal() {
            adviceModal.classList.remove('show');
            instructionsModal.classList.add('show');
        }

        function hideInstructionsAndShowTeamSelection() {
            instructionsModal.classList.remove('show');
            showTeamSelectionModal();
        }

        function showTeamSelectionModal() {
            teamSelectionModal.classList.add('show');
        }

        function hideAllModals() {
            adviceModal.classList.remove('show');
            instructionsModal.classList.remove('show');
            teamSelectionModal.classList.remove('show');
            teamNameInputModal.classList.remove('show');
            finalWinnerModal.classList.remove('show');
            countdownOverlay.classList.remove('show');
            resetConfirmationModal.classList.remove('show');
            clearConfetti();
        }

        let selectedNumTeams = 0;

        function selectTeams(numTeams) {
            selectedNumTeams = numTeams;
            hideAllModals();
            showTeamNameInputModal(numTeams);
        }

        function showTeamNameInputModal(numTeams) {
            teamNameInputsContainer.innerHTML = '';
            const defaultNames = {
                "blue": "الفريق الأزرق",
                "red": "الفريق الأحمر",
                "green": "الفريق الأخضر",
                "orange": "الفريق البرتقالي"
            };
            for (let i = 0; i < numTeams; i++) {
                const teamColor = teamColors[i];
                const inputDiv = document.createElement('div');
                const label = document.createElement('label');
                label.textContent = `${defaultNames[teamColor]}:`;
                label.setAttribute('for', `teamName${i}`);
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `teamName${i}`;
                input.name = `teamName${i}`;
                input.value = teamNames[teamColor] || defaultNames[teamColor];
                input.dataset.teamColor = teamColor;
                inputDiv.appendChild(label);
                inputDiv.appendChild(input);
                teamNameInputsContainer.appendChild(inputDiv);
            }
            teamNameInputModal.classList.add('show');
        }

        function confirmTeamNames() {
            const teamNameInputs = teamNameInputsContainer.querySelectorAll('input[type="text"]');
            teamNameInputs.forEach(input => {
                const teamColor = input.dataset.teamColor;
                teamNames[teamColor] = input.value.trim() || teamNames[teamColor];
            });
            hideAllModals();
            initializeGameSetup();
        }

        function initializeGameSetup() {
            activeTeams = teamColors.slice(0, selectedNumTeams);
            scores = {};
            activeTeams.forEach(team => {
                scores[team] = 0;
            });

            scoreboardDiv.innerHTML = '';
            activeTeams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.classList.add('team', team);
                teamDiv.dataset.team = team;
                teamDiv.innerHTML = `${teamNames[team]}: <span id="score${team.charAt(0).toUpperCase() + team.slice(1)}">0</span>`;
                scoreboardDiv.appendChild(teamDiv);
            });
            scoreBoardElements = {};
            activeTeams.forEach(color => {
                const elem = document.querySelector(`.team.${color}`);
                if (elem) scoreBoardElements[color] = elem;
            });

            currentTeamIndex = 0;
            startingTeamIndexForRound = 0;
            currentGroupIndex = 0;
            roundIndex = 0;
            isTieBreakerRound = false;
            matchedPairsCount = 0;

            const initialRoundData = allGameRounds[currentGroupIndex][roundIndex];
            createBoard(initialRoundData);
            hideAllCards();
            disableClicking();
            timerContainer.textContent = "";
            resultDisplay.textContent = `دور فريق: ${teamNames[activeTeams[currentTeamIndex]]}`;
            updateActiveTeamDisplay();

            gameArea.style.display = 'flex';
            startGameBtn.textContent = "بدء الجولة";
            startGameBtn.style.display = 'inline-block';
            nextGroupBtn.style.display = 'none';
            resetGameBtn.style.display = 'inline-block';
            enableControls();
            gameInitialized = true;
            isTransitioning = false;
            console.log("Game initialized and ready to start.");
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getTotalCellsForGridClass(gridClass) {
            switch (gridClass) {
                case "size-15": return 15;
                case "size-18": return 18;
                default: return 0;
            }
        }

        function revealCell(cell) {
            if (cell.classList.contains('empty') || cell.classList.contains('matched')) return;
            cell.classList.remove("hidden");
            if (cell.dataset.specialType === 'star-placeholder') {
                cell.textContent = '⭐';
                cell.style.color = '#222';
                cell.style.filter = 'none';
                cell.style.textShadow = 'none';
                cell.style.backgroundColor = '#ffffff';
                cell.style.fontSize = 'clamp(30px, 6vw, 45px)'; // Ensure responsiveness for star
            }
        }

        function hideCell(cell) {
            if (cell.dataset.specialType === 'star-placeholder') {
                cell.textContent = board[cell.dataset.index].value;
                cell.style.color = 'transparent';
                cell.style.backgroundColor = '#0055AA';
                cell.classList.add("hidden");
            } else {
                cell.textContent = board[cell.dataset.index].value; // To ensure value is present if needed for debug
                cell.style.color = 'transparent';
                cell.style.backgroundColor = '#0055AA';
                cell.classList.add("hidden");
            }
        }

        function hideAllCards() {
            const cells = document.querySelectorAll('.cell:not(.empty)');
            cells.forEach(cell => {
                hideCell(cell);
            });
        }

        function disableClicking() {
            grid.style.pointerEvents = 'none';
        }

        function enableClicking() {
            grid.style.pointerEvents = 'auto';
        }

        function createBoard(roundData) {
            grid.innerHTML = '';
            board = [];
            grid.className = 'grid';
            grid.classList.add(roundData.gridSizeClass);

            let values = [];
            if (roundData.type === "emoji") {
                values = [...roundData.emojis, ...roundData.emojis];
            } else if (roundData.type === "words" || roundData.type === "math") {
                roundData.textPairs.forEach(pair => {
                    values.push(pair[0], pair[1]);
                });
            } else if (roundData.type === "letter-word") {
                roundData.letterWordPairs.forEach(pair => {
                    values.push(pair[0], pair[1]);
                });
            } else if (roundData.type === "incomplete-word") {
                roundData.incompleteWordPairs.forEach(pair => {
                    values.push(pair[0], pair[1]);
                });
            } else if (isTieBreakerRound) {
                values = [...tieBreakerEmojis, ...tieBreakerEmojis];
            }

            shuffle(values);

            const totalCells = getTotalCellsForGridClass(roundData.gridSizeClass);
            const numContentCells = values.length;
            const numEmptyCells = totalCells - numContentCells;

            let shuffledContent = [...values];
            let fullBoardContent = [];

            // Add content cells
            shuffledContent.forEach(val => {
                fullBoardContent.push({ value: val, matched: false, type: roundData.type, specialType: null });
            });

            // Add empty cells
            for (let i = 0; i < numEmptyCells; i++) {
                fullBoardContent.push({ value: '', matched: true, type: 'empty', specialType: null });
            }

            shuffle(fullBoardContent);

            // Place special squares (star)
            let starPlacedCount = 0;
            const starValue = isTieBreakerRound ? tieBreakerFixedValue : getRandomStarValue();

            // Find valid indices for special squares
            let possibleStarIndices = [];
            for (let i = 0; i < fullBoardContent.length; i++) {
                if (fullBoardContent[i].type !== 'empty') {
                    possibleStarIndices.push(i);
                }
            }
            shuffle(possibleStarIndices); // Randomize positions for stars

            for (let i = 0; i < roundData.specialSquaresCount && possibleStarIndices.length > 0; i++) {
                const starIndex = possibleStarIndices.pop(); // Take a random available index
                fullBoardContent[starIndex] = { value: starValue, matched: false, type: 'special', specialType: 'star-placeholder' };
                starPlacedCount++;
            }

            board = fullBoardContent; // Update the global board with special squares

            board.forEach((item, index) => {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                if (item.type === 'empty') {
                    cell.classList.add('empty');
                } else {
                    cell.classList.add('hidden', 'text-content'); // Add text-content class by default
                    cell.dataset.index = index;
                    cell.dataset.value = item.value;
                    cell.dataset.roundType = item.type; // Store round type for specific styling
                    if (item.specialType === 'star-placeholder') {
                        cell.dataset.specialType = 'star-placeholder';
                        cell.style.fontSize = 'clamp(30px, 6vw, 45px)'; // Ensure star size is responsive
                    }
                    cell.addEventListener('click', () => pickCard(cell));
                }
                grid.appendChild(cell);
            });
        }

        function getRandomStarValue() {
            const currentRound = allGameRounds[currentGroupIndex][roundIndex];
            const baseValue = Math.floor(currentGroupIndex * 2) + 1; // 1 for Group 1, 3 for Group 2, 5 for Group 3
            const value = Math.floor(Math.random() * baseValue) + 1;
            return Math.random() < 0.5 ? value : -value;
        }

        function pickCard(cell) {
            if (lockBoard || cell === firstPick || cell.classList.contains('matched') || cell.classList.contains('empty')) return;

            revealCell(cell);

            if (!firstPick) {
                firstPick = cell;
                return;
            }

            let secondPick = cell;
            lockBoard = true; // Lock board after two cards are picked

            if (firstPick.dataset.specialType === 'star-placeholder') {
                handleStarCard(firstPick);
                return;
            } else if (secondPick.dataset.specialType === 'star-placeholder') {
                handleStarCard(secondPick);
                return;
            }

            // Normal matching logic
            if (firstPick.dataset.value === secondPick.dataset.value) {
                // It's a match!
                matchedPairsCount++;
                activeTeams[currentTeamIndex] = activeTeams[currentTeamIndex]; // Ensure current team exists
                scores[activeTeams[currentTeamIndex]] += 1; // Add 1 point for a match
                updateScoreboard();

                firstPick.classList.add('matched');
                secondPick.classList.add('matched');
                board[firstPick.dataset.index].matched = true;
                board[secondPick.dataset.index].matched = true;

                resetBoard(); // Reset for next pick

                const currentRound = isTieBreakerRound ?
                    { totalEmojiPairs: tieBreakerTotalEmojiPairs, specialSquaresCount: tieBreakerSpecialSquaresCount } :
                    allGameRounds[currentGroupIndex][roundIndex];
                const expectedMatches = currentRound.totalEmojiPairs;
                const totalCellsToMatch = (expectedMatches * 2) + currentRound.specialSquaresCount;
                const matchedCells = document.querySelectorAll('.cell.matched').length;

                if (matchedCells >= totalCellsToMatch) {
                    endRound();
                }
            } else {
                // Not a match
                setTimeout(() => {
                    hideCell(firstPick);
                    hideCell(secondPick);
                    resetBoard();
                    nextTurn();
                }, 1000);
            }
        }

        function handleStarCard(starCard) {
            const value = parseInt(starCard.dataset.value);
            const team = activeTeams[currentTeamIndex];

            // Apply points
            scores[team] += value;
            updateScoreboard();

            // Animate card to show value
            starCard.textContent = value > 0 ? `+${value}` : `${value}`;
            starCard.classList.add('value-revealed', value > 0 ? 'positive' : 'negative');
            starCard.style.color = 'white'; // Ensure text color is white for revealed value

            // Mark as matched and disable further interaction
            starCard.classList.add('matched');
            board[starCard.dataset.index].matched = true;
            matchedPairsCount++; // Count special squares for round completion

            setTimeout(() => {
                // If the round is not over, visually reset the star card after revealing
                if (!isRoundOver()) {
                    starCard.classList.remove('value-revealed', 'positive', 'negative');
                    starCard.textContent = board[starCard.dataset.index].value; // Restore value for hiding logic
                    hideCell(starCard); // Hide it again
                    resetBoard();
                    nextTurn();
                } else {
                    resetBoard();
                    endRound();
                }
            }, 1500); // Keep revealed for 1.5 seconds

            // Check if round is over after handling the star card
            const currentRound = isTieBreakerRound ?
                { totalEmojiPairs: tieBreakerTotalEmojiPairs, specialSquaresCount: tieBreakerSpecialSquaresCount } :
                allGameRounds[currentGroupIndex][roundIndex];
            const expectedMatches = currentRound.totalEmojiPairs;
            const totalCellsToMatch = (expectedMatches * 2) + currentRound.specialSquaresCount;
            const matchedCells = document.querySelectorAll('.cell.matched').length;

            if (matchedCells >= totalCellsToMatch) {
                // If it's the last card, ensure endRound is called without delay
                if (!isTransitioning) { // Prevent multiple calls
                    setTimeout(endRound, 1500); // Delay endRound to let star animation finish
                }
            }
        }


        function isRoundOver() {
            const currentRoundData = isTieBreakerRound ?
                { totalEmojiPairs: tieBreakerTotalEmojiPairs, specialSquaresCount: tieBreakerSpecialSquaresCount } :
                allGameRounds[currentGroupIndex][roundIndex];

            const totalContentCells = (currentRoundData.totalEmojiPairs * 2) + currentRoundData.specialSquaresCount;
            const matchedCellsOnBoard = document.querySelectorAll('.cell.matched:not(.empty)').length;
            return matchedCellsOnBoard >= totalContentCells;
        }

        function resetBoard() {
            firstPick = null;
            lockBoard = false;
        }

        function updateScoreboard() {
            activeTeams.forEach(team => {
                document.getElementById(`score${team.charAt(0).toUpperCase() + team.slice(1)}`).textContent = scores[team];
            });
        }

        function updateActiveTeamDisplay() {
            activeTeams.forEach((team, index) => {
                const teamElem = scoreBoardElements[team];
                if (teamElem) {
                    if (index === currentTeamIndex) {
                        teamElem.classList.add('active');
                        resultDisplay.textContent = `دور فريق: ${teamNames[team]}`;
                    } else {
                        teamElem.classList.remove('active');
                    }
                }
            });
        }

        function nextTurn() {
            if (isRoundOver()) {
                endRound();
                return;
            }
            currentTeamIndex = (currentTeamIndex + 1) % activeTeams.length;
            updateActiveTeamDisplay();
        }

        function startTimer(duration, onEnd) {
            clearInterval(timerInterval);
            let timer = duration;
            timerContainer.textContent = `الوقت المتبقي: ${timer} ثواني`;
            timerInterval = setInterval(() => {
                timer--;
                timerContainer.textContent = `الوقت المتبقي: ${timer} ثواني`;
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    timerContainer.textContent = "انتهى الوقت!";
                    onEnd();
                }
            }, 1000);
        }

        function handleStartOrNextRound() {
            if (isTransitioning) return;
            isTransitioning = true;
            disableControls();

            let roundData;
            if (isTieBreakerRound) {
                roundData = {
                    emojis: tieBreakerEmojis,
                    gridSizeClass: "size-15", // Tie-breaker always uses 3x5 grid
                    timer: tieBreakerTimer,
                    category: "جولة التعادل",
                    specialSquaresCount: tieBreakerSpecialSquaresCount,
                    totalEmojiPairs: tieBreakerTotalEmojiPairs,
                    type: "emoji" // Treat tie-breaker as emoji type for content generation
                };
            } else {
                roundData = allGameRounds[currentGroupIndex][roundIndex];
            }

            resultDisplay.textContent = `فئة الجولة: ${roundData.category}`;
            updateActiveTeamDisplay();

            createBoard(roundData); // Create and display board with values

            countdownText.textContent = "الاستعداد للجولة...";
            countdownNumber.textContent = "3";
            countdownOverlay.classList.add('show');

            let countdown = 3;
            const preRoundCountdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownNumber.textContent = countdown;
                } else if (countdown === 0) {
                    countdownNumber.textContent = "انطلق!";
                } else {
                    clearInterval(preRoundCountdownInterval);
                    countdownOverlay.classList.remove('show');
                    startGame();
                }
            }, 1000);

            function startGame() {
                startTimer(roundData.timer, () => {
                    hideAllCards(); // Hide cards after timer
                    enableClicking(); // Allow clicking only after cards are hidden
                    startGameBtn.textContent = "إعادة الجولة";
                    enableControls();
                    isTransitioning = false;
                });
            }
        }

        function endRound() {
            if (isTransitioning) return;
            isTransitioning = true;
            clearInterval(timerInterval);
            disableClicking();
            disableControls();

            const currentRoundData = isTieBreakerRound ?
                { category: "جولة التعادل" } :
                allGameRounds[currentGroupIndex][roundIndex];
            resultDisplay.textContent = `انتهت جولة ${currentRoundData.category}!`;

            // Display all cards briefly for review
            const cells = document.querySelectorAll('.cell:not(.empty)');
            cells.forEach(cell => {
                revealCell(cell);
            });

            setTimeout(() => {
                hideAllCards(); // Hide them again after review
                if (isTieBreakerRound) {
                    showFinalWinner();
                    return;
                }

                roundIndex++;
                if (roundIndex < allGameRounds[currentGroupIndex].length) {
                    // Next round in current group
                    handleNextRoundInGroup();
                } else {
                    // End of current group
                    endGroup();
                }
            }, 3000); // Display cards for 3 seconds after round end
        }

        function handleNextRoundInGroup() {
            const nextRoundData = allGameRounds[currentGroupIndex][roundIndex];
            createBoard(nextRoundData);
            hideAllCards();
            disableClicking();
            matchedPairsCount = 0; // Reset matched pairs for the new round
            firstPick = null;
            lockBoard = false;

            // Rotate starting team for the new round within the same group
            startingTeamIndexForRound = (startingTeamIndexForRound + 1) % activeTeams.length;
            currentTeamIndex = startingTeamIndexForRound;
            updateActiveTeamDisplay();

            countdownText.textContent = "الجولة القادمة تبدأ في...";
            countdownNumber.textContent = interRoundDelay;
            countdownOverlay.classList.add('show');

            let countdown = interRoundDelay;
            const interRoundInterval = setInterval(() => {
                countdown--;
                countdownNumber.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interRoundInterval);
                    countdownOverlay.classList.remove('show');
                    startGameBtn.textContent = "بدء الجولة";
                    enableControls();
                    isTransitioning = false;
                }
            }, 1000);
        }


        function endGroup() {
            currentGroupIndex++;
            roundIndex = 0; // Reset round index for the new group
            matchedPairsCount = 0; // Reset matched pairs for the new group

            if (currentGroupIndex < allGameRounds.length) {
                // More groups left
                resultDisplay.textContent = `انتهت المجموعة الحالية! اضغط "المجموعة التالية" للانتقال.`;
                startGameBtn.style.display = 'none'; // Hide Start Game button
                nextGroupBtn.style.display = 'inline-block'; // Show Next Group button
                enableControls();
                isTransitioning = false;
            } else {
                // All groups completed
                resultDisplay.textContent = `انتهت جميع الجولات!`;
                showFinalWinner();
            }
        }

        function nextGroupManually() {
            if (isTransitioning) return; // Prevent double clicks
            isTransitioning = true;
            disableControls();
            nextGroupBtn.style.display = 'none'; // Hide "المجموعة التالية" button

            const nextRoundData = allGameRounds[currentGroupIndex][roundIndex];
            createBoard(nextRoundData);
            hideAllCards();
            disableClicking();
            matchedPairsCount = 0;
            firstPick = null;
            lockBoard = false;

            startingTeamIndexForRound = (startingTeamIndexForRound + 1) % activeTeams.length;
            currentTeamIndex = startingTeamIndexForRound;
            updateActiveTeamDisplay();

            countdownText.textContent = "المجموعة القادمة تبدأ في...";
            countdownNumber.textContent = interRoundDelay;
            countdownOverlay.classList.add('show');

            let countdown = interRoundDelay;
            const interGroupInterval = setInterval(() => {
                countdown--;
                countdownNumber.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interGroupInterval);
                    countdownOverlay.classList.remove('show');
                    startGameBtn.textContent = "بدء الجولة";
                    startGameBtn.style.display = 'inline-block'; // Show start game button
                    enableControls();
                    isTransitioning = false;
                }
            }, 1000);
        }


        function showFinalWinner() {
            hideAllModals(); // Hide any other open modals
            gameArea.style.display = 'none'; // Hide game area
            clearInterval(timerInterval); // Stop any running timer

            let maxScore = -Infinity;
            let winners = [];
            let isTie = false;

            activeTeams.forEach(team => {
                if (scores[team] > maxScore) {
                    maxScore = scores[team];
                    winners = [team];
                    isTie = false;
                } else if (scores[team] === maxScore && maxScore !== -Infinity) {
                    winners.push(team);
                    isTie = true;
                }
            });

            if (winners.length === 1) {
                const winnerTeamColor = winners[0];
                finalWinnerText.textContent = `الفريق الفائز هو: ${teamNames[winnerTeamColor]}!`;
                finalWinnerText.style.color = teamCssColors[winnerTeamColor]; // Set text color to winning team's color
                finalTieText.textContent = '';
                startTieBreakerBtn.style.display = 'none'; // Hide tie-breaker button

                // Trigger confetti for the winner
                triggerConfetti();

            } else {
                // It's a tie
                finalWinnerText.textContent = 'تعادل بين الفرق!';
                finalWinnerText.style.color = '#007bff'; // Blue for tie
                const tiedTeamsNames = winners.map(team => teamNames[team]).join(' و ');
                finalTieText.textContent = `الفرق المتعادلة: ${tiedTeamsNames}`;
                startTieBreakerBtn.style.display = 'inline-block'; // Show tie-breaker button
            }

            finalWinnerModal.classList.add('show');
        }

        function startTieBreaker() {
            hideAllModals();
            isTieBreakerRound = true;
            // Filter activeTeams to only include tied teams for tie-breaker
            let maxScore = -Infinity;
            let tiedTeams = [];
            activeTeams.forEach(team => {
                if (scores[team] > maxScore) {
                    maxScore = scores[team];
                    tiedTeams = [team];
                } else if (scores[team] === maxScore && maxScore !== -Infinity) {
                    tiedTeams.push(team);
                }
            });
            activeTeams = tiedTeams; // Only tied teams participate
            currentTeamIndex = 0;
            startingTeamIndexForRound = 0; // Reset starting team for tie-breaker
            scores = {}; // Reset scores for tie-breaker
            activeTeams.forEach(team => scores[team] = 0); // Initialize tied teams with 0 score

            // Update scoreboard to show only tied teams
            scoreboardDiv.innerHTML = '';
            activeTeams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.classList.add('team', team);
                teamDiv.dataset.team = team;
                teamDiv.innerHTML = `${teamNames[team]}: <span id="score${team.charAt(0).toUpperCase() + team.slice(1)}">0</span>`;
                scoreboardDiv.appendChild(teamDiv);
            });
            scoreBoardElements = {}; // Re-populate scoreBoardElements for active teams
            activeTeams.forEach(color => {
                const elem = document.querySelector(`.team.${color}`);
                if (elem) scoreBoardElements[color] = elem;
            });

            matchedPairsCount = 0; // Reset for tie-breaker
            gameArea.style.display = 'flex'; // Show game area
            handleStartOrNextRound(); // Start the tie-breaker round
        }

        function resetGame() {
            hideAllModals();
            clearInterval(timerInterval);
            currentGroupIndex = 0;
            roundIndex = 0;
            matchedPairsCount = 0;
            isTieBreakerRound = false;
            gameInitialized = false;
            firstPick = null;
            lockBoard = false;

            // Clear scoreboard and hide game area
            scoreboardDiv.innerHTML = '';
            gameArea.style.display = 'none';

            // Reset scores and team names (optional, based on desired behavior)
            scores = {};
            teamNames = {
                "blue": "الفريق الأزرق",
                "red": "الفريق الأحمر",
                "green": "الفريق الأخضر",
                "orange": "الفريق البرتقالي"
            };

            // Show initial advice modal to start fresh
            showAdviceModal();
        }

        function showResetConfirmation() {
            resetConfirmationModal.classList.add('show');
        }

        confirmResetBtn.addEventListener('click', resetGame);
        cancelResetBtn.addEventListener('click', () => {
            resetConfirmationModal.classList.remove('show');
        });

        playAgainBtn.addEventListener('click', resetGame);
        startTieBreakerBtn.addEventListener('click', startTieBreaker);

        function enableControls() {
            startGameBtn.disabled = false;
            resetGameBtn.disabled = false;
            nextGroupBtn.disabled = false;
        }

        function disableControls() {
            startGameBtn.disabled = true;
            resetGameBtn.disabled = true;
            nextGroupBtn.disabled = true;
        }

        function triggerConfetti() {
            const numConfetti = 50;
            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -50}px`; // Start above screen
                confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`; // 2-5 seconds
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                document.body.appendChild(confetti);
                confetti.addEventListener('animationend', () => confetti.remove());
            }
        }

        function clearConfetti() {
            document.querySelectorAll('.confetti').forEach(c => c.remove());
        }


        // Initial setup
        showAdviceModal();
    </script>
</body>
</html>
