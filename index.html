<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ูุนุจุฉ ุตูุฏูุง - ุงูุฐุงูุฑุฉ ุงูุนุงุฆููุฉ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e6f7ff;
            color: #222;
            text-align: center;
            padding: 20px;
            direction: rtl;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            /* Removed: overflow: hidden; */ /* ูููุน ุธููุฑ ุดุฑูุท ุงูุชูุฑูุฑ ุจุณุจุจ ุงููุตุงุตุงุช */
            position: relative;
        }

        /* ุงูููุงุญุธุฉ ุงููุงููููุฉ */
        .legal-notice {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffe0b2;
            color: #8d6e63;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-bottom: 1px solid #d7ccc8;
            line-height: 1.5;
            text-align: center;
        }
        .legal-notice span {
            display: block;
            margin-top: 5px;
            font-style: italic;
            font-weight: normal;
        }

        /* ูุงูุฐุฉ ุงูููุฏุงู */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* ุชู ุงูุชุนุฏูู: ุฅุฎูุงุก ุงูุชุฑุงุถููุง ุจูุงุณุทุฉ CSS */
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0; /* ุชู ุงูุชุนุฏูู: ุงูุดูุงููุฉ ุงูุงูุชุฑุงุถูุฉ */
            pointer-events: none; /* ุชู ุงูุชุนุฏูู: ุชุนุทูู ุงูุชูุงุนู ุนูุฏ ุงูุฅุฎูุงุก */
            transition: opacity 0.3s ease-out;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
            display: flex; /* ุชู ุงูุชุนุฏูู: ุฅุธูุงุฑ ุงููุงูุฐุฉ ูู flexbox ุนูุฏ ูุฌูุฏ ูุฆุฉ show */
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            text-align: center;
            line-height: 1.6;
            animation: fadeIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
            color: #333;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            color: #007bff;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .modal-content ul {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .modal-content ul li {
            margin-bottom: 10px;
            font-size: 1.1em;
            text-align: right;
            padding-right: 10px;
            border-right: 3px solid #007bff;
        }

        .modal-content p {
            font-size: 1.1em;
            margin-top: 25px;
            font-weight: bold;
            color: #555;
        }
        .modal-content .button-group {
            margin-top: 30px;
        }
        .modal-content button {
            background-color: #004080; /* lighter blue */
            color: white;
            border: none;
            padding: 18px 35px; /* ุชู ุงูุชุนุฏูู: ุชูุจูุฑ ุงูุฃุฒุฑุงุฑ */
            border-radius: 8px;
            font-size: 1.3em; /* ุชู ุงูุชุนุฏูู: ุชูุจูุฑ ุงูุฎุท */
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0 10px;
        }
        .modal-content button:hover {
            background-color: #003366; /* slightly darker on hover */
        }

        /* Welcome Modal Specific Styles */
        #welcomeModal .modal-content h2 {
            color: #004080; /* Darker blue to match button */
            margin-bottom: 25px;
        }
        #welcomeModal .modal-content img {
            max-width: 80%;
            height: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        #welcomeModal .modal-content button {
            background-color: #004080; /* lighter blue */
            color: white;
            padding: 18px 40px;
            font-size: 1.4em;
        }
        #welcomeModal .modal-content button:hover {
            background-color: #003366;
        }


        /* ุดุงุดุฉ ุงุฎุชูุงุฑ ุงููุฑู */
        #teamSelectionModal .team-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap; /* Added for responsiveness */
        }
        #teamSelectionModal .team-options button {
            background-color: #004080; /* lighter blue */
            font-size: 1.3em; /* ุชู ุงูุชุนุฏูู: ุชูุจูุฑ ุงูุฎุท */
            padding: 18px 35px; /* ุชู ุงูุชุนุฏูู: ุชูุจูุฑ ุงูุฃุฒุฑุงุฑ */
        }
        #teamSelectionModal .team-options button:hover {
            background-color: #003366; /* slightly darker on hover */
        }

        /* ุดุงุดุฉ ุชุณููุฉ ุงููุฑู */
        #teamNameInputModal .team-name-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        #teamNameInputModal .team-name-inputs div {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #teamNameInputModal .team-name-inputs label {
            font-weight: bold;
            min-width: 80px;
            text-align: right;
            color: #007bff;
        }
        #teamNameInputModal .team-name-inputs input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: right;
        }
        #teamNameInputModal .team-name-inputs input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }


        /* ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ ููุนุจุฉ */
        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 900px; /* ุชู ุงูุชุนุฏูู: ุฒูุงุฏุฉ ุนุฑุถ ุงูููุทูุฉ ูุชูุงุณุจ ุงููุฑุจุนุงุช ุงูุฃูุจุฑ */
            padding: 0 10px; /* Added for responsiveness */
            box-sizing: border-box; /* Added for responsiveness */
            margin-top: 60px; /* ูุณุงูุฉ ูู ุงูุดุฑูุท ุงูุนููู */
        }

        .scoreboard {
            display: flex;
            justify-content: center;
            gap: 20px; /* ุชู ุงูุชุนุฏูู: ุฒูุงุฏุฉ ุงููุณุงูุฉ ุจูู ุงููุฑู */
            margin: 20px 0 10px; /* ุชูููู ุงููุงูุด ุงูุณููู ูููุฑุจ "ุฏูุฑ ุงููุฑูู" */
            flex-wrap: wrap;
        }

        .team {
            padding: 12px 20px; /* ุชู ุงูุชุนุฏูู: ุชูุจูุฑ ุญุฌู ุงููุฑู ูู ููุญุฉ ุงููุชุงุฆุฌ */
            border-radius: 12px; /* ุชู ุงูุชุนุฏูู: ุฒูุงุฏุฉ ูุตู ูุทุฑ ุงูุญูุงู */
            background: #e0f7fa;
            font-weight: bold;
            font-size: 1.1em; /* ุชู ุงูุชุนุฏูู: ุชูุจูุฑ ุงูุฎุท */
            min-width: 120px; /* ุชู ุงูุชุนุฏูู: ุฒูุงุฏุฉ ุงูุนุฑุถ ุงูุฃุฏูู */
            border: 3px solid transparent; /* ุชู ุงูุชุนุฏูู: ุฒูุงุฏุฉ ุณูู ุงูุญุฏูุฏ */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* ุชู ุงูุชุนุฏูู: ุธู ุฃูุจุฑ */
            display: flex; /* ูุชุฑุชูุจ ุงูุงุณู ูุงูููุงุท */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1 1 auto; /* Added for responsiveness */
            min-width: 140px; /* Ensure teams don't get too small */
            max-width: 200px; /* Prevent them from getting too big on large screens */
        }
        .team span { /* ุงูููุงุท ุฏุงุฎู ุงููุฑูู */
            font-size: 1.8em; /* ุชู ุงูุชุนุฏูู: ุชูุจูุฑ ุญุฌู ุงูููุงุท */
            margin-top: 5px;
            color: #004085; /* ููู ุฃุฒุฑู ุบุงูู ููููุงุท */
        }

        /* ุฃููุงู ุงููุฑู */
        .blue { background-color: #cce5ff; color: #004085; }
        .red { background-color: #f8d7da; color: #721c24; }
        .green { background-color: #d4edda; color: #155724; }
        .orange { background-color: #fff3cd; color: #856404; }

        /* ุชูููุฒ ุงููุฑูู ุงูุฐู ุนููู ุงูุฏูุฑ */
        .team.active {
            border-color: #007bff;
            box-shadow: 0 0 12px rgba(0, 123, 255, 0.6); /* ุชู ุงูุชุนุฏูู: ุธู ุฃูุจุฑ ูุฃูุถุญ */
            transform: translateY(-5px); /* ุชู ุงูุชุนุฏูู: ุงุฑุชูุงุน ุฃูุจุฑ */
        }

        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 15px; /* ุชู ุงูุชุนุฏูู: ุฒูุงุฏุฉ ุงููุณุงูุฉ ุจูู ุงูุฃุฒุฑุงุฑ */
            flex-wrap: wrap; /* Added for responsiveness */
        }

        .controls button {
            background-color: #004080; /* lighter blue */
            color: white;
            border: none;
            padding: 18px 35px; /* ุชู ุงูุชุนุฏูู: ุชูุจูุฑ ุงูุฃุฒุฑุงุฑ */
            border-radius: 10px; /* ุชู ุงูุชุนุฏูู: ุฒูุงุฏุฉ ูุตู ูุทุฑ ุงูุญูุงู */
            font-size: 1.3em; /* ุชู ุงูุชุนุฏูู: ุชูุจูุฑ ุงูุฎุท */
            margin: 0;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            flex: 1 1 auto; /* Added for responsiveness */
            min-width: 150px; /* Ensure buttons don't get too small */
            max-width: 250px; /* Prevent them from getting too big */
        }

        .controls button:hover {
            background-color: #003366; /* slightly darker on hover */
            transform: translateY(-2px);
        }

        .controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .timer {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            min-height: 35px;
        }

        /* ุงูุชุฎุทูุท ุงูุงูุชุฑุงุถู ููุดุจูุฉ */
        .grid {
            display: grid;
            grid-gap: 20px; /* ุชู ุงูุชุนุฏูู: ุฒูุงุฏุฉ ุงููุณุงูุฉ ุจูู ุงููุฑุจุนุงุช */
            justify-content: center;
            margin: 20px auto;
            max-width: fit-content;
        }

        /* ุฃุญุฌุงู ุงูุฎูุงูุง ุงูุงูุชุฑุงุถูุฉ */
        .cell {
            border-radius: 15px; /* ุชู ุงูุชุนุฏูู: ุฒูุงุฏุฉ ูุตู ูุทุฑ ุงูุญูุงู */
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3); /* ุชู ุงูุชุนุฏูู: ุธู ุฃูุจุฑ */
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, filter 0.3s ease; /* ุฃุถู filter */
            user-select: none;
            color: #222;
            text-align: center; /* ูููููุงุช */
            line-height: 1.2; /* ูููููุงุช */
            padding: 5px; /* ูููููุงุช */
            box-sizing: border-box; /* ูุถูุงู ุนุฏู ุชุฌุงูุฒ ุงูุจุงุฏููุฌ ููุญุฌู */
        }
        .cell:not(.matched):not(.empty):hover {
            transform: scale(1.05); /* ุชุฃุซูุฑ ุชูุจูุฑ ุนูุฏ ุงูุชุญููู */
        }

        /* ุงูุฎูุงูุง ุงููุงุฑุบุฉ */
        .cell.empty {
            background-color: transparent;
            box-shadow: none;
            cursor: default;
            pointer-events: none;
        }

        .cell.hidden {
            background-color: #0055AA; /* lighter blue for hidden cells */
            color: transparent !important; /* ูุฎูู ูุญุชูู ุงููุต */ /* **ุชู ุงูุชุนุฏูู ููุง** */
            cursor: pointer;
        }

        .cell.matched {
            background-color: #a3cfbb;
            cursor: default;
            pointer-events: none;
            transform: none; /* ุฅุฒุงูุฉ ุชุฃุซูุฑ ุงูุชุญููู ูููุทุงุจูุฉ */
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2); /* ุธู ุฏุงุฎูู ูููุทุงุจูุฉ */
        }

        /* ููุท ุฎุงุต ูุจุทุงูุฉ +/- 1 ุนูุฏ ุงููุดู ุนููุง ูู ูุฑุญูุฉ ุงููุนุจ */
        .cell.value-revealed {
            font-weight: bold;
            font-size: 4em; /* ููุชูุงุณุจ ูุน ุญุฌู ุงูุฎููุฉ ุงูุฌุฏูุฏุฉ */
            transform: none; /* ุฅุฒุงูุฉ ุชุฃุซูุฑ ุงูุชุญููู */
            color: white !important; /* ูุถูุงู ุฃู ุงููุต ุฃุจูุถ */
        }
        .cell.value-revealed.negative {
            background-color: #dc3545; /* ุฃุญูุฑ */
        }
        .cell.value-revealed.positive {
            background-color: #28a745; /* ุฃุฎุถุฑ */
        }

        /* ุฃุญุฌุงู ุงูุดุจูุฉ ุญุณุจ ุงูุฌููุฉ */
        /* ุฌููุงุช 15 ูุฑุจุนูุง -> ุชุฎุทูุท 3x5 */
        .grid.size-15 .cell { width: 140px; height: 140px; }
        .grid.size-15 { grid-template-columns: repeat(5, 140px); grid-template-rows: repeat(3, 140px); }

        /* ุฌููุงุช 18 ูุฑุจุนูุง -> ุชุฎุทูุท 3x6 */
        .grid.size-18 .cell { width: 110px; height: 110px; }
        .grid.size-18 { grid-template-columns: repeat(6, 110px); grid-template-rows: repeat(3, 110px); }

        /* ููุท ุฎุงุต ููุฎูุงูุง ุงูุชู ุชุญุชูู ุนูู ูุตูุต ุฃู ุฃุฑูุงู ุญุณุงุจูุฉ */
        .cell.text-content {
            font-size: 35px; /* ุญุฌู ุฎุท ูููุตูุต ุงูุงูุชุฑุงุถูุฉ (ุฅูููุฌูุ ูููุงุชุ ุฃุฑูุงู) */
            font-weight: bold;
            display: flex; /* ูุถูุงู ุชูุณูุท ุงููุต */
            align-items: center;
            justify-content: center;
            white-space: normal; /* ุงูุณูุงุญ ุจุงูุงูุชูุงู */
            word-break: break-word; /* ูุณุฑ ุงููููุงุช ุงูุทูููุฉ */
        }

        /* ุชุนุฏููุงุช ูุญุฏุฏุฉ ููุฎุท ูุฌููุงุช ุงููููุงุช ูุงููุฑุงุฏูุงุช/ุงูุฃุถุฏุงุฏ ูุงูุนูููุงุช ุงูุญุณุงุจูุฉ */
        .cell[data-round-type="words"],
        .cell[data-round-type="math"],
        .cell[data-round-type="letter-word"],
        .cell[data-round-type="incomplete-word"] {
            font-size: 30px; /* ุญุฌู ุฎุท ุฃุตุบุฑ ูุฌููุงุช ุงููููุงุช ูุงููุฑุงุฏูุงุช/ุงูุฃุถุฏุงุฏ ูุงูุนูููุงุช ุงูุญุณุงุจูุฉ */
        }
        /* ุชุนุฏูู ุฎุงุต ูุญุฌู ุฎุท ุงูุฅูููุฌู ูุงููุฌูุฉ */
        .cell[data-round-type="emoji"],
        .cell[data-special-type="star-placeholder"] { /* */
            font-size: 45px; /* ุชู ุงูุชุนุฏูู: ุญุฌู ุฎุท 45px ููุฅูููุฌู ูุงููุฌูุฉ (ููุงุณุจ ุฃุฑูุงู ุฌููุฉ ุงูุชุนุงุฏู) */
        }


        /* ููุงู ูุชุตููู ุฑุณุงูุฉ "ุฏูุฑ ุงููุฑูู" */
        .result {
            margin-top: 10px; /* ูุงูุด ุนููู ููุตุจุญ ุชุญุช ููุญุฉ ุงููุชุงุฆุฌ ูุจุงุดุฑุฉ */
            margin-bottom: 20px; /* ูุงูุด ุณููู ูุชุจุนุฏ ุนู ุงูุนุฏุงุฏ */
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            min-height: 30px; /* ูุชุฌูุจ ุงูุชุฒุงุฒ ุงูุชุฎุทูุท ุนูุฏ ุชุบูุฑ ุงููุญุชูู */
        }

        /* ุชุฃุซูุฑ ุงูุญุฑูู ุงูุนุฑุจูุฉ ุงููุชุณุงูุทุฉ */
        .falling-letter {
            position: absolute;
            top: -50px;
            font-size: 2.5em;
            color: rgba(0, 51, 102, 0.3);
            animation: fall linear infinite;
            pointer-events: none;
            user-select: none;
            opacity: 0;
            z-index: -1;
        }

        @keyframes fall {
            0% { transform: translateY(-50px) translateX(0) scale(0.8); opacity: 0; }
            10% { opacity: 0.7; }
            90% { opacity: 0; }
            100% { transform: translateY(100vh) translateX(0) scale(1.2); opacity: 0; }
        }

        /* ุดุงุดุฉ ุงูุนุฏ ุงูุชูุงุฒูู ุงููุฎูุฉ */
        #countdownOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; /* ุชู ุงูุชุนุฏูู: ููุง ูุฌุจ ุฃู ูููู flex ุจุดูู ุฏุงุฆู */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 5em;
            font-weight: bold;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        #countdownOverlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        #countdownText {
            margin-bottom: 20px;
            font-size: 0.5em;
            text-align: center;
        }

        #countdownNumber {
            font-size: 2em;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.1); opacity: 0.8; }
        }

        /* ุดุงุดุฉ ุงูููุฒ ุงูููุงุฆูุฉ */
        #finalWinnerModal { /* ูู ูุชู ุชุบููุฑูุง ููุงุ ุจู ูู .modal-overlay */
            color: white;
            z-index: 4000;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
        }

        #finalWinnerModal.show { /* ูู ูุชู ุชุบููุฑูุง ููุงุ ุจู ูู .modal-overlay.show */
            /* opacity ู pointer-events ู display ุชุฃุชู ูู .modal-overlay.show */
        }

        #finalWinnerModal h2 {
            font-size: 4em;
            margin-bottom: 30px;
            color: #ffd700; /* ุฐูุจู - ุณูุชู ุชุบููุฑู ุฏููุงูููููุง ูููู ุงููุฑูู */
            text-shadow: 3px 3px 10px rgba(255,165,0,0.8);
        }
        #finalWinnerModal p {
            font-size: 2em;
            margin-bottom: 40px;
        }

        #finalWinnerModal button {
            background-color: #004080; /* lighter blue */
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin: 0 10px; /* ุฅุถุงูุฉ ูุงูุด ุจูู ุงูุฃุฒุฑุงุฑ */
        }

        #finalWinnerModal button:hover {
            background-color: #003366; /* slightly darker on hover */
            transform: translateY(-3px);
        }

        /* ุชุฃุซูุฑ ุงููุตุงุตุงุช */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00; /* Default color */
            animation: fallConfetti 5s linear forwards;
            opacity: 0;
            border-radius: 50%; /* ูุฌุนู ุงููุตุงุตุงุช ูุณุชุฏูุฑุฉ */
        }

        @keyframes fallConfetti {
            0% { transform: translateY(-100px) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(120vh) rotateZ(720deg); opacity: 0; }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .legal-notice {
                font-size: 12px;
                padding: 5px 10px;
            }
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            .modal-content h2 {
                font-size: 1.8em;
            }
            .modal-content ul li, .modal-content p {
                font-size: 1em;
            }
            .modal-content button {
                padding: 15px 25px;
                font-size: 1.1em;
                margin: 5px;
            }

            #teamSelectionModal .team-options button,
            .controls button {
                padding: 15px 25px;
                font-size: 1.1em;
            }

            .scoreboard {
                gap: 10px;
            }
            .team {
                padding: 8px 15px;
                font-size: 0.9em;
                min-width: 100px;
            }
            .team span {
                font-size: 1.5em;
            }

            .timer {
                font-size: 22px;
            }
            .result {
                font-size: 20px;
            }

            /* Adjust grid and cell sizes for smaller screens */
            .grid.size-15 {
                grid-template-columns: repeat(3, 100px); /* 3 columns for 15 cells */
                grid-template-rows: repeat(5, 100px);
            }
            .grid.size-15 .cell {
                width: 100px;
                height: 100px;
            }

            .grid.size-18 {
                grid-template-columns: repeat(3, 90px); /* 3 columns for 18 cells */
                grid-template-rows: repeat(6, 90px);
            }
            .grid.size-18 .cell {
                width: 90px;
                height: 90px;
            }

            .cell.text-content,
            .cell[data-round-type="words"],
            .cell[data-round-type="math"],
            .cell[data-round-type="letter-word"],
            .cell[data-round-type="incomplete-word"] {
                font-size: 24px;
            }
            .cell[data-round-type="emoji"],
            .cell[data-special-type="star-placeholder"] {
                font-size: 35px;
            }
            .cell.value-revealed {
                font-size: 3em;
            }

            #countdownNumber {
                font-size: 1.5em;
            }
            #countdownText {
                font-size: 0.4em;
            }

            #finalWinnerModal h2 {
                font-size: 3em;
            }
            #finalWinnerModal p {
                font-size: 1.5em;
            }
            #finalWinnerModal button {
                padding: 15px 30px;
                font-size: 1.2em;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                padding: 15px; /* ุชูููู ุงูุจุงุฏููุฌ ุนูู ุงูุฌูุงูุงุช ุงูุตุบูุฑุฉ */
            }
            .modal-content h2 {
                font-size: 1.5em;
            }
            .modal-content ul li, .modal-content p {
                font-size: 0.9em;
            }
            .modal-content button {
                padding: 12px 20px;
                font-size: 1em;
            }

            #welcomeModal .modal-content h2 {
                font-size: 1.8em;
            }
            #welcomeModal .modal-content button {
                padding: 15px 30px;
                font-size: 1.2em;
            }

            #teamSelectionModal .team-options button,
            .controls button {
                padding: 12px 20px;
                font-size: 1em;
                min-width: unset; /* Allow smaller for very small screens */
                flex: 1 1 100%; /* Stack buttons on very small screens */
            }

            .team {
                min-width: unset; /* Allow smaller */
                font-size: 0.8em;
                padding: 6px 10px;
            }
            .team span {
                font-size: 1.2em;
            }
            .scoreboard {
                flex-direction: column; /* Stack teams vertically if too narrow */
                gap: 5px;
            }

            .timer {
                font-size: 18px;
            }
            .result {
                font-size: 18px;
            }

            /* Further reduce cell sizes for very small screens */
            .grid.size-15 {
                grid-template-columns: repeat(3, 80px);
                grid-template-rows: repeat(5, 80px);
            }
            .grid.size-15 .cell {
                width: 80px;
                height: 80px;
            }

            .grid.size-18 {
                grid-template-columns: repeat(3, 70px);
                grid-template-rows: repeat(6, 70px);
            }
            .grid.size-18 .cell {
                width: 70px;
                height: 70px;
            }

            .cell.text-content,
            .cell[data-round-type="words"],
            .cell[data-round-type="math"],
            .cell[data-round-type="letter-word"],
            .cell[data-round-type="incomplete-word"] {
                font-size: 20px;
            }
            .cell[data-round-type="emoji"],
            .cell[data-special-type="star-placeholder"] {
                font-size: 30px;
            }
            .cell.value-revealed {
                font-size: 2.5em;
            }

            #countdownNumber {
                font-size: 1.2em;
            }
            #countdownText {
                font-size: 0.35em;
            }

            #finalWinnerModal h2 {
                font-size: 2.5em;
            }
            #finalWinnerModal p {
                font-size: 1.2em;
            }
            #finalWinnerModal button {
                padding: 12px 25px;
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>

    <div class="legal-notice">
        ููุงุญุธุฉ: ูุฐู ุงููุณุฎุฉ ูุดุฎุต ูุงุญุฏ ููุท ูุบูุฑ ูุงุจูุฉ ูููุดุฑ ุฃู ุงูุจูุน. ููู ูุฎุงูู ุฐูู ุณูุชู ุงุชุฎุงุฐ ุงูุฅุฌุฑุงุกุงุช ุงููุงููููุฉ ูู ูุฐุง ุงูุฃูุฑ.
        <span>ูููุชุฐููุฑ ุจุฐูุชู ูุฃูุงูุชู: "ูุงู ๏ทบ: ูุง ุฅููุงู ููู ูุง ุฃูุงูุฉ ููุ ููุง ุฏูู ููู ูุง ุนูุฏ ูู"</span>
    </div>

    <div id="countdownOverlay" class="modal-overlay"> <div id="countdownText"></div>
        <div id="countdownNumber"></div>
    </div>

    <div id="finalWinnerModal" class="modal-overlay"> <div class="modal-content">
            <h2 id="finalWinnerText"></h2>
            <p id="finalTieText"></p>
            <div class="button-group">
                <button id="playAgainBtn">ุฅุนุงุฏุฉ ุชุนููู ูุจุฏุก ูุนุจุฉ ุฌุฏูุฏุฉ</button>
                <button id="startTieBreakerBtn" style="display: none;">ุจุฏุก ุฌููุฉ ุงูุชุนุงุฏู</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="welcomeModal">
        <div class="modal-content">
            <h2>ุฃููุงู ุจู ูู ูุนุจุฉ "ุตูุฏูุง"</h2>
            <img src="https://raw.githubusercontent.com/seedaha1/seedaha1/main/sedaha-removebg-preview.png" alt="ุดุนุงุฑ ุงููุนุจุฉ">
            <div class="button-group">
                <button onclick="showAdviceModal()">ุงูุชุงูู</button>
            </div>
        </div>
    </div>


    <div class="modal-overlay" id="adviceModal"> <div class="modal-content">
            <h2>ูุตูุญุฉ ุนูุดุงู ููุนุจ ููุณุชุงูุณโฆ ุจุณ ุจุฏูู ูุง ููุณู ุงูุฃูู ๐</h2>
            <ul>
                <li>โฐ "ุงููุนุจ ููุชุนุ ุจุณ ุฎููู ุจุนุฏ ุงูุตูุงุฉุ ุนุดุงู ูุง ุชุถูุน ุนููู ูุง ูุชุนุฉ ููุง ุฃุฌุฑ."</li>
                <li>๐ "ุงููุนุจุฉ ุญููุฉุ ุจุณ ุงููุฑุขู ุฃุญููุ ุฎุฐ ูู ููุช ุจูู ุงูุฌููุงุช ูุงุฑุชูุญ ูุน ููุงู ุงููู."</li>
                <li>๐ "ุฅุฐุง ุฌุงุก ููุช ุงูุตูุงุฉุ ูููู ุงููุนุจ ูููุณุจ ุฑุถุง ุฑุจ ุงูุนุงูููู."</li>
                <li>โ "ููุนุจ ููุถุญูุ ููู ูุง ูุฎูู ุงููุนุจ ูููููุง ุนู ุทุงุนุฉ ุงููู."</li>
                <li>๐ "ุงููุนุจุฉ ุฌุฒุก ูู ููููุงุ ูู ูู ููููุงโฆ ูุง ุชูุณู ุฃูุฏุงูู ูุทููุญุงุชู."</li>
                <li>๐ฏ "ุงููุนุจุฉ ูุง ุชููุน ุฅูู ุชุฐุงูุฑุ ูุธูู ููุชู ูุฎูู ุงููุนุจ ููุงูุฃุฉ ุจุนุฏ ุงูุฅูุฌุงุฒ."</li>
                <li>โ "ููุช ุงููุฐุงูุฑุฉ ุบุงููุ ูุง ุชุฎููู ูุถูุน ุนูู ุญุณุงุจ ุฌูู ูููู ุชูุนุจู ุจุฃู ููุช."</li>
            </ul>
            <p>"ุฅุฐุง ูุนุจุช ูุฃูุช ูุญุงูุธ ุนูู ุตูุงุชู ูุฃุฐูุงุฑู ููุฑุงุกุฉ ุงููุฑุขู ูุฎูุตุช ุงููุฐุงูุฑุฉ ูุงูุฃุดุบุงู ุงููู ุนูููโฆ ุฃูุช ูุณุจุช ุงูุฏููุง ูุงูุขุฎุฑุฉ ุจุฅุฐู ุงููู"</p>
            <div class="button-group">
                <button onclick="showInstructionsModal()">ุงูุชุงูู</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="instructionsModal"> <div class="modal-content">
            <h2>๐ ุชุนูููุงุช ูุนุจุฉ ุตูุฏูุง ๐ฎ</h2>
            <ul>
                <li>๐ **ุงููุฏู:** ูุทุงุจูุฉ ุงูุฑููุฒ ุฃู ุงููููุงุช ุฃู ุงูุนูููุงุช ุงูุญุณุงุจูุฉ ุงููุชุดุงุจูุฉ ูู ุฎูุงูุง ุงูุดุจูุฉ.</li>
                <li>1๏ธโฃ **ุงุฎุชูุงุฑ ุงููุฆุฉ:** (ููุงุญุธุฉ: ูุชู ุงุฎุชูุงุฑ ุงููุฆุฉ ุชููุงุฆููุง ุจุงูุชุฑุชูุจ ูู ูุฐู ุงููุนุจุฉ).</li>
                <li>2๏ธโฃ **ุจุฏุก ุงูุฌููุฉ:** ุงุถุบุท ุฒุฑ **ุจุฏุก ุงูุฌููุฉ** ูุนุฑุถ ุงูุฑููุฒ ุนูู ุงูุดุจูุฉ ููุฏุฉ ูุญุฏุฏุฉ โณ ูุน ุนุฏุงุฏ ูุธูุฑ ุงูููุช. ุฎูุงู ูุฐู ุงููุชุฑุฉุ ุญุงูู ุชุฐูุฑ ุฃูุงูู ุงูุฑููุฒ.</li>
                <li>3๏ธโฃ **ูุทุงุจูุฉ ุงูุฑููุฒ:** ุจุนุฏ ุงูุชูุงุก ุงูููุช โฐุ ุชุนูุฏ ุงูุฎูุงูุง ูุฃุฑูุงู ููุทุ ุงุจุฏุฃ ุจุงูููุฑ ุนูู ุฎููุชูู:
                    <ul>
                        <li>โ ุฅุฐุง ุชุทุงุจู ุงูุฑูุฒุงูุ ููุณุจ ุงููุฑูู ุฃู ุงููุงุนุจูู ููุทุฉ ุนูู ูู ุชุทุงุจู ุตุญูุญ.</li>
                        <li>โ ุฅุฐุง ูู ุชุชุทุงุจูุ ูุง ููุณุจ ุฃู ููุทุฉ.</li>
                    </ul>
                </li>
                <li>4๏ธโฃ **ุจุทุงูุฉ ุงููุฌูุฉ โญ:** ุฅุฐุง ูุดูุช ุจุทุงูุฉ **ุงููุฌูุฉ โญ**ุ ุณูุชู ุฅุถุงูุฉ ุฃู ุฎุตู ููุงุท ูู ุฑุตูุฏ ูุฑููู! (ุชุชุบูุฑ ูููุชูุง ุนุดูุงุฆูุงู ุจูู ุณุงูุจ ูููุฌุจ ูุชุฒูุฏ ูุน ูู ูุฌููุนุฉ ุฌููุงุชุ ููููู ุฅุนุงุฏุฉ ูุชุญูุง!).</li>
                <li>5๏ธโฃ **ุงูุชูุงุก ุงูุฌููุฉ:** ุนูุฏ ุงููุดู ุนู ูู **ุฃุฒูุงุฌ ุงูุฑููุฒ ุงูุนุงุฏูุฉ**ุ ุณุชููู ุงูุฌููุฉ ูุฏ ุงูุชูุช. ุงููุนุจุฉ ุณุชูุชูู ุชููุงุฆููุง ุฅูู ุงูุฌููุฉ ุงูุชุงููุฉ ุฏุงุฎู ุงููุฌููุนุฉ.</li>
                <li>6๏ธโฃ **ุงูุงูุชูุงู ูููุฌููุนุฉ ุงูุชุงููุฉ:** ุจุนุฏ ุงูุชูุงุก ุฌููุน ุฌููุงุช ุงููุฌููุนุฉุ ุณูุธูุฑ ุฒุฑ **"ุงููุฌููุนุฉ ุงูุชุงููุฉ"** ููุงูุชูุงู ูุฏูููุง.</li>
                <li>๐ **ุฒุฑ ุฅุนุงุฏุฉ ุชุนููู:** ูุนูุฏ ุงููุนุจุฉ ููุญุงูุฉ ุงูุงุจุชุฏุงุฆูุฉ ูุชุฎุชุงุฑ ุนุฏุฏ ุงููุฑู ุฃู ุชุนูุฏ ุงูุฌููุฉ.</li>
            </ul>
            <div class="button-group">
                <button onclick="hideInstructionsAndShowTeamSelection()">ุจุฏุก ุงููุนุจุฉ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="teamSelectionModal"> <div class="modal-content">
            <h2>ุงุฎุชุฑ ุนุฏุฏ ุงููุฑู</h2>
            <div class="team-options">
                <button onclick="selectTeams(2)">2 ูุฑู</button>
                <button onclick="selectTeams(3)">3 ูุฑู</button>
                <button onclick="selectTeams(4)">4 ูุฑู</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="teamNameInputModal"> <div class="modal-content">
            <h2>ุณููู ุงููุฑู</h2>
            <div class="team-name-inputs" id="teamNameInputsContainer">
                </div>
            <div class="button-group">
                <button onclick="confirmTeamNames()">ุชุฃููุฏ ุงูุฃุณูุงุก</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resetConfirmationModal">
        <div class="modal-content">
            <h2>ูู ุฃูุช ูุชุฃูุฏุ</h2>
            <p>ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุชุนููู ุงููุนุจุฉ ูุจุฏุก ูู ุฌุฏูุฏุ ุณุชููุฏ ุฌููุน ุงูููุงุท ุงูุญุงููุฉ.</p>
            <div class="button-group">
                <button id="confirmResetBtn">ุชุฃููุฏ</button>
                <button id="cancelResetBtn">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>

    <div class="game-area">
        <div class="scoreboard" id="scoreboard">
            </div>

        <div class="result" id="result"></div>

        <div class="timer" id="timerContainer"></div>

        <div class="grid" id="grid"></div>

        <div class="controls">
            <button onclick="handleStartOrNextRound()" id="startGameBtn">ุจุฏุก ุงูุฌููุฉ</button>
            <button onclick="nextGroupManually()" id="nextGroupBtn" style="display: none;">ุงููุฌููุนุฉ ุงูุชุงููุฉ</button>
            <button onclick="showResetConfirmation()" id="resetGameBtn">ุฅุนุงุฏุฉ ุชุนููู</button>
        </div>
    </div>

    <script>
        // ุชุนุฑูู ูุฆุงุช ุงูุฌููุงุช (ูุญุฏุซุฉ)
        const roundCategories = [
            "ููุงูู", "ุฎุถุฑูุงุช", "ุงูุฃุฏูุงุช", "ุงููุฑูุจุงุช", // ุงููุฌููุนุฉ ุงูุฃููู
            "ุงูุญุฑู ูุงููููุฉ", "ุฃููู ุงููููุฉ", "ูุฑุงุฏู ุงููููุฉ", "ุงููููุฉ ูุนูุณูุง", // ุงููุฌููุนุฉ ุงูุซุงููุฉ
            "ุนูููุฉ ุฌูุน", "ุนูููุฉ ุทุฑุญ", "ุนูููุฉ ุถุฑุจ", "ุนูููุฉ ูุณูุฉ" // ุงููุฌููุนุฉ ุงูุซุงูุซุฉ
        ];

        // ุงููุฌููุนุฉ ุงูุฃููู
        const group1Rounds = [
            { emojis: ["๐", "๐", "๐", "๐", "๐", "๐", "๐ฅญ", "๐ฅ"], gridSizeClass: "size-18", timer: 10, category: roundCategories[0], specialSquaresCount: 2, totalEmojiPairs: 8, type: "emoji" },
            { emojis: ["๐ฅ", "๐ฅ", "๐ง", "๐ฅฆ", "๐ฅ", "๐ถ๏ธ", "๐", "๐ฝ"], gridSizeClass: "size-18", timer: 10, category: roundCategories[1], specialSquaresCount: 2, totalEmojiPairs: 8, type: "emoji" },
            { emojis: ["๐จ", "๐ง", "๐ก", "โ๏ธ", "๐", "๐", "๐", "๐ฑ"], gridSizeClass: "size-18", timer: 5, category: roundCategories[2], specialSquaresCount: 2, totalEmojiPairs: 8, type: "emoji" },
            { emojis: ["๐", "๐", "๐ฒ", "๐", "๐", "๐ค", "๐ต", "๐ข"], gridSizeClass: "size-18", timer: 5, category: roundCategories[3], specialSquaresCount: 2, totalEmojiPairs: 8, type: "emoji" }
        ];

        // ุงููุฌููุนุฉ ุงูุซุงููุฉ
        const group2Rounds = [
            { letterWordPairs: [["ุฃ", "ุฃุณุฏ"], ["ุจ", "ุจูุฑุฉ"], ["ุช", "ุชูุณุงุญ"], ["ุฌ", "ุฌูู"], ["ุญ", "ุญุตุงู"], ["ุฏ", "ุฏุจ"], ["ุฒ", "ุฒุฑุงูุฉ"]], gridSizeClass: "size-15", timer: 10, category: roundCategories[4], specialSquaresCount: 1, totalEmojiPairs: 7, type: "letter-word" },
            { incompleteWordPairs: [["ูุชุงุจ", "ูุช_ุจ", "ุง"], ["ููู", "ู_ู", "ู"], ["ุดูุณ", "ุด_ุณ", "ู"], ["ููุฑ", "ู_ุฑ", "ู"], ["ุจุญุฑ", "ุจ_ุฑ", "ุญ"], ["ูุฑุฏุฉ", "ูุฑ_ุฉ", "ุฏ"], ["ุชูุงุญ", "ุช_ุงุญ", "ู"]], gridSizeClass: "size-15", timer: 10, category: roundCategories[5], specialSquaresCount: 1, totalEmojiPairs: 7, type: "incomplete-word" },
            { textPairs: [["ุณุนูุฏ", "ูุฑุญ"], ["ูุจูุฑ", "ุถุฎู"], ["ุตุบูุฑ", "ุถุฆูู"], ["ุณุฑูุน", "ุนุงุฌู"], ["ุจุทูุก", "ูุชุจุงุทุฆ"], ["ุฌููู", "ุญูู"], ["ุฐูู", "ุนุจูุฑู"]], gridSizeClass: "size-15", timer: 5, category: roundCategories[6], specialSquaresCount: 1, totalEmojiPairs: 7, type: "words" },
            { textPairs: [["ุตุบูุฑ", "ูุจูุฑ"], ["ูุฑูุจ", "ุจุนูุฏ"], ["ุทููู", "ูุตูุฑ"], ["ุญุงุฑ", "ุจุงุฑุฏ"], ["ููู", "ููุงุฑ"], ["ุตุนูุฏ", "ูุจูุท"], ["ุฏุงุฎู", "ุฎุงุฑุฌ"]], gridSizeClass: "size-15", timer: 5, category: roundCategories[7], specialSquaresCount: 1, totalEmojiPairs: 7, type: "words" }
        ];

        // ุงููุฌููุนุฉ ุงูุซุงูุซุฉ (ุงูุนูููุงุช ุงูุญุณุงุจูุฉ)
        const group3Rounds = [
            { mathPairs: [["2+3", "5"], ["5+4", "9"], ["10+2", "12"], ["7+1", "8"], ["6+6", "12"], ["9+3", "12"], ["4+7", "11"]], gridSizeClass: "size-15", timer: 15, category: roundCategories[8], specialSquaresCount: 1, totalEmojiPairs: 7, type: "math" },
            { mathPairs: [["8-2", "6"], ["7-3", "4"], ["10-5", "5"], ["9-1", "8"], ["12-4", "8"], ["11-6", "5"], ["15-7", "8"]], gridSizeClass: "size-15", timer: 15, category: roundCategories[9], specialSquaresCount: 1, totalEmojiPairs: 7, type: "math" },
            { mathPairs: [["2*3", "6"], ["4*2", "8"], ["5*5", "25"], ["3*7", "21"], ["6*4", "24"], ["8*3", "24"], ["7*5", "35"]], gridSizeClass: "size-15", timer: 15, category: roundCategories[10], specialSquaresCount: 1, totalEmojiPairs: 7, type: "math" },
            { mathPairs: [["10/2", "5"], ["12/3", "4"], ["15/5", "3"], ["18/6", "3"], ["20/4", "5"], ["24/8", "3"], ["28/7", "4"]], gridSizeClass: "size-15", timer: 15, category: roundCategories[11], specialSquaresCount: 1, totalEmojiPairs: 7, type: "math" }
        ];

        let allGameRounds = [group1Rounds, group2Rounds, group3Rounds]; // ุชุฑุชูุจ ุงููุฌููุนุงุช

        // ุจูุงูุงุช ุฌููุฉ ุงูุชุนุงุฏู
        const tieBreakerEmojis = [
            "505", "515", "525", "535", "545", "555", "575"
        ];
        const tieBreakerTimer = 5;
        const tieBreakerSpecialSquaresCount = 1; // ุฌููุฉ ุงูุชุนุงุฏู ูุฑุจุน ุฎุงุต ูุงุญุฏ ููุท
        const tieBreakerFixedValue = 4; // ูููุฉ ุซุงุจุชุฉ 4 ูุฌููุฉ ุงูุชุนุงุฏู (ูููู ุฃู ุชููู +4 ุฃู -4)
        const tieBreakerTotalEmojiPairs = 7;

        const interRoundDelay = 10; // ููุช ุงูุนุฏ ุงูุชูุงุฒูู ุจูู ุงูุฌููุงุช (ุชู ุงูุชุนุฏูู ุฅูู 10 ุซูุงูู)

        let teamNames = { // Default team names, will be updated by user input
            "blue": "ุงููุฑูู ุงูุฃุฒุฑู",
            "red": "ุงููุฑูู ุงูุฃุญูุฑ",
            "green": "ุงููุฑูู ุงูุฃุฎุถุฑ",
            "orange": "ุงููุฑูู ุงูุจุฑุชูุงูู"
        };
        const teamColors = ["blue", "red", "green", "orange"];
        // Define actual CSS colors for team names for consistency
        const teamCssColors = {
            "blue": "#004085",
            "red": "#721c24",
            "green": "#155724",
            "orange": "#856404"
        };
        let activeTeams = [];
        let currentTeamIndex = 0;
        let startingTeamIndexForRound = 0;

        let currentGroupIndex = 0; // ูุคุดุฑ ูููุฌููุนุฉ ุงูุญุงููุฉ (0 ูููุฌููุนุฉ ุงูุฃูููุ 1 ูููุฌููุนุฉ ุงูุซุงููุฉ)
        let roundIndex = 0; // ูุคุดุฑ ููุฌููุฉ ุฏุงุฎู ุงููุฌููุนุฉ ุงูุญุงููุฉ

        let board = [];
        let firstPick = null;
        let lockBoard = false;
        let scores = {}; // ุงูููุงุท ุงูุขู ุชุฑุงูููุฉ
        let matchedPairsCount = 0; // ูุนุฏ ุงูุฃุฒูุงุฌ ุงูุนุงุฏูุฉ ุงููุทุงุจูุฉ ููุท
        let timerInterval = null;
        let isTieBreakerRound = false;
        let gameInitialized = false; // ูุชุบูุฑ ุฌุฏูุฏ ูุชุชุจุน ูุง ุฅุฐุง ูุงูุช ุงููุนุจุฉ ูููุฃุฉ (ุงููุงุฌูุฉ ุธุงูุฑุฉ ููุณุชุนุฏุฉ ููุจุฏุก)
        let isTransitioning = false; // ูููุน ุชูุฑุงุฑ ุงูุนุฏุงุฏ

        const welcomeModal = document.getElementById("welcomeModal"); // New welcome modal
        const adviceModal = document.getElementById("adviceModal");
        const instructionsModal = document.getElementById("instructionsModal");
        const teamSelectionModal = document.getElementById("teamSelectionModal");
        const teamNameInputModal = document.getElementById("teamNameInputModal"); // New modal for team names
        const teamNameInputsContainer = document.getElementById("teamNameInputsContainer"); // Container for team name inputs
        const gameArea = document.querySelector(".game-area");

        const grid = document.getElementById("grid");
        const timerContainer = document.getElementById("timerContainer");
        const resultDisplay = document.getElementById("result");
        const startGameBtn = document.getElementById("startGameBtn");
        const nextGroupBtn = document.getElementById("nextGroupBtn"); // ุฒุฑ ุงููุฌููุนุฉ ุงูุชุงููุฉ
        const resetGameBtn = document.getElementById("resetGameBtn");
        const scoreboardDiv = document.getElementById("scoreboard");
        let scoreBoardElements = {};

        const countdownOverlay = document.getElementById("countdownOverlay");
        const countdownText = document.getElementById("countdownText");
        const countdownNumber = document.getElementById("countdownNumber");

        const finalWinnerModal = document.getElementById("finalWinnerModal");
        const finalWinnerText = document.getElementById("finalWinnerText");
        const finalTieText = document.getElementById("finalTieText");
        const playAgainBtn = document.getElementById("playAgainBtn");
        const startTieBreakerBtn = document.getElementById("startTieBreakerBtn");

        const resetConfirmationModal = document.getElementById("resetConfirmationModal"); // New modal
        const confirmResetBtn = document.getElementById("confirmResetBtn");
        const cancelResetBtn = document.getElementById("cancelResetBtn");

        const arabicLetters = ['ุง', 'ุจ', 'ุช', 'ุซ', 'ุฌ', 'ุญ', 'ุฎ', 'ุฏ', 'ุฐ', 'ุฑ', 'ุฒ', 'ุณ', 'ุด', 'ุต', 'ุถ', 'ุท', 'ุธ', 'ุน', 'ุบ', 'ู', 'ู', 'ู', 'ู', 'ู', 'ู', 'ู', 'ู', 'ู'];
        const confettiColors = ["#f44336", "#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4", "#009688", "#4CAF50", "#8BC34A", "#CDDC39", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722", "#795548", "#9E9E9E", "#607D8B"];


        // --- ูุธุงุฆู ุชุฃุซูุฑุงุช ุงูุฎูููุฉ ูุงูุญุฑูู ุงููุชุณุงูุทุฉ ---
        function createFallingLetter() {
            const letter = document.createElement('span');
            letter.textContent = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
            letter.classList.add('falling-letter');
            letter.style.left = `${Math.random() * 100}vw`;
            letter.style.animationDuration = `${Math.random() * 8 + 5}s`;
            letter.style.animationDelay = `${Math.random() * 5}s`;
            document.body.appendChild(letter);

            letter.addEventListener('animationend', () => {
                letter.remove();
                createFallingLetter();
            });
        }

        for (let i = 0; i < 20; i++) {
            createFallingLetter();
        }

        // --- ูุธุงุฆู ุงูููุฏุงู (ุงูููุงูุฐ ุงูููุจุซูุฉ) ---
        function showWelcomeModal() {
            welcomeModal.classList.add('show');
            gameArea.style.display = 'none'; // Hide game area initially
        }

        function showAdviceModal() {
            welcomeModal.classList.remove('show');
            adviceModal.classList.add('show'); // ุชู ุงูุชุนุฏูู
            gameArea.style.display = 'none'; // ุฅุฎูุงุก ููุทูุฉ ุงููุนุจ ุญุชู ุชูุชูู ุงูุฅุนุฏุงุฏุงุช ุงูุฃูููุฉ
            finalWinnerModal.classList.remove('show'); // ุงูุชุฃูุฏ ูู ุฅุฎูุงุก ูุงูุฐุฉ ุงูููุฒ
            clearConfetti(); // ูุณุญ ุงููุตุงุตุงุช ุฅู ูุฌุฏุช
        }

        function showInstructionsModal() {
            adviceModal.classList.remove('show'); // ุชู ุงูุชุนุฏูู
            instructionsModal.classList.add('show'); // ุชู ุงูุชุนุฏูู
        }

        function hideInstructionsAndShowTeamSelection() {
            instructionsModal.classList.remove('show'); // ุชู ุงูุชุนุฏูู
            showTeamSelectionModal();
        }

        function showTeamSelectionModal() {
            teamSelectionModal.classList.add('show'); // ุชู ุงูุชุนุฏูู
        }

        function hideAllModals() {
            welcomeModal.classList.remove('show'); // New: Hide welcome modal
            adviceModal.classList.remove('show'); // ุชู ุงูุชุนุฏูู
            instructionsModal.classList.remove('show'); // ุชู ุงูุชุนุฏูู
            teamSelectionModal.classList.remove('show'); // ุชู ุงูุชุนุฏูู
            teamNameInputModal.classList.remove('show'); // ุชู ุงูุชุนุฏูู
            finalWinnerModal.classList.remove('show'); // ุชู ุงูุชุนุฏูู
            countdownOverlay.classList.remove('show'); // ุชุฃูุฏ ูู ุฅุฎูุงุก ุนุฏุงุฏ ุงูุฌููุฉ ุฃูุถูุง
            resetConfirmationModal.classList.remove('show'); // Hide reset confirmation modal
            clearConfetti();
        }

        let selectedNumTeams = 0; // Store the number of teams selected

        function selectTeams(numTeams) {
            selectedNumTeams = numTeams; // Store the number of teams
            hideAllModals();
            showTeamNameInputModal(numTeams); // Show team name input modal next
        }

        function showTeamNameInputModal(numTeams) {
            teamNameInputsContainer.innerHTML = ''; // Clear previous inputs

            // Define default names based on color order
            const defaultNames = {
                "blue": "ุงููุฑูู ุงูุฃุฒุฑู",
                "red": "ุงููุฑูู ุงูุฃุญูุฑ",
                "green": "ุงููุฑูู ุงูุฃุฎุถุฑ",
                "orange": "ุงููุฑูู ุงูุจุฑุชูุงูู"
            };

            for (let i = 0; i < numTeams; i++) {
                const teamColor = teamColors[i]; // Get the color code
                const inputDiv = document.createElement('div');
                const label = document.createElement('label');
                label.textContent = `${defaultNames[teamColor]}:`; // Use default name for label
                label.setAttribute('for', `teamName${i}`);

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `teamName${i}`;
                input.name = `teamName${i}`;
                input.value = teamNames[teamColor] || defaultNames[teamColor]; // Pre-fill with current custom name or default
                input.dataset.teamColor = teamColor; // Store the color in dataset

                inputDiv.appendChild(label);
                inputDiv.appendChild(input);
                teamNameInputsContainer.appendChild(inputDiv);
            }

            teamNameInputModal.classList.add('show'); // ุชู ุงูุชุนุฏูู
        }

        function confirmTeamNames() {
            const teamNameInputs = teamNameInputsContainer.querySelectorAll('input[type="text"]');
            teamNameInputs.forEach(input => {
                const teamColor = input.dataset.teamColor;
                teamNames[teamColor] = input.value.trim() || teamNames[teamColor]; // Update with custom name, or keep current default if empty
            });

            hideAllModals();
            initializeGameSetup(); // Proceed to game setup after names are confirmed
        }

        function initializeGameSetup() {
            activeTeams = teamColors.slice(0, selectedNumTeams); // Use selectedNumTeams
            scores = {};
            activeTeams.forEach(team => {
                scores[team] = 0; // ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุท ุนูุฏ ุจุฏุก ูุนุจุฉ ุฌุฏูุฏุฉ
            });

            // ุชุญุฏูุซ ููุญุฉ ุงููุชุงุฆุฌ
            scoreboardDiv.innerHTML = '';
            activeTeams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.classList.add('team', team);
                teamDiv.dataset.team = team;
                teamDiv.innerHTML = `${teamNames[team]}: <span id="score${team.charAt(0).toUpperCase() + team.slice(1)}">0</span>`;
                scoreboardDiv.appendChild(teamDiv);
            });
            scoreBoardElements = {};
            activeTeams.forEach(color => {
                const elem = document.querySelector(`.team.${color}`);
                if (elem) scoreBoardElements[color] = elem;
            });

            // ุฅุนุงุฏุฉ ุชุนููู ูุคุดุฑุงุช ุงูุฌููุฉ ูุงููุฑูู ููุญุงูุฉ ุงูุงุจุชุฏุงุฆูุฉ
            currentTeamIndex = 0;
            startingTeamIndexForRound = 0;
            currentGroupIndex = 0; // ูุจุฏุฃ ุฏุงุฆููุง ูู ุงููุฌููุนุฉ ุงูุฃููู
            roundIndex = 0; // ููุจุฏุฃ ูู ุงูุฌููุฉ ุงูุฃููู ุฏุงุฎููุง
            isTieBreakerRound = false;
            matchedPairsCount = 0;

            // ุฅูุดุงุก ุงูููุญุฉ ูููุฑุฉ ุงูุฃููู ููุงุ ูููู ุณุชููู ุงูุฎูุงูุง ูุฎููุฉ ุงูุชุฑุงุถููุง
            const initialRoundData = allGameRounds[currentGroupIndex][roundIndex];
            createBoard(initialRoundData); // ุชูุฑูุฑ ุจูุงูุงุช ุงูุฌููุฉ ุงูุฃูููุฉ
            hideAllCards(); // ุชุฃูุฏ ูู ุฅุฎูุงุฆูุง ูุจุงุดุฑุฉ ุจุนุฏ ุงูุฅูุดุงุก

            disableClicking(); // ุชุนุทูู ุงูููุฑ ุญุชู ุจุฏุก ุงูุฌููุฉ ุงููุนููุฉ
            timerContainer.textContent = ""; // ูุณุญ ูุต ุงููุคูุช
            resultDisplay.textContent = `ุฏูุฑ ูุฑูู: ${teamNames[activeTeams[currentTeamIndex]]}`;
            updateActiveTeamDisplay(); // ุชุญุฏูุซ ุนุฑุถ ุงููุฑูู ุงููุดุท

            // ุนุฑุถ ููุทูุฉ ุงููุนุจ ูุงููุฉ ุงูุขู
            gameArea.style.display = 'flex';
            startGameBtn.textContent = "ุจุฏุก ุงูุฌููุฉ"; // ุงูุชุฃูุฏ ูู ูุต ุงูุฒุฑ
            startGameBtn.style.display = 'inline-block';
            nextGroupBtn.style.display = 'none'; // ุฅุฎูุงุก ุฒุฑ ุงููุฌููุนุฉ ุงูุชุงููุฉ ูู ุงูุจุฏุงูุฉ
            resetGameBtn.style.display = 'inline-block';
            enableControls(); // ุชูููู ุงูุฃุฒุฑุงุฑ ุนูุฏ ูุฐู ุงูููุทุฉ

            gameInitialized = true; // ุงููุนุจุฉ ุงูุขู ูููุฃุฉ ูุฌุงูุฒุฉ ููุจุฏุก
            isTransitioning = false; // ุชุฃููุฏ ุนุฏู ูุฌูุฏ ุงูุชูุงู ุนูุฏ ุงูุจุฏุก
            console.log("Game initialized and ready to start.");
        }


        // --- ูุธุงุฆู ุงููุนุจุฉ ุงูุฃุณุงุณูุฉ ---
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getTotalCellsForGridClass(gridClass) {
            switch (gridClass) {
                case "size-15": return 15; // 3x5
                case "size-18": return 18; // 3x6
                default: return 0;
            }
        }

        // ุฏุงูุฉ ูุนุฑุถ ูุญุชูู ุงูุฎููุฉ
        function revealCell(cell) {
            if (cell.classList.contains('empty') || cell.classList.contains('matched')) return;
            cell.classList.remove("hidden");
            
            // ุงูุชุนุงูู ูุน ูุฑุจุน ุงููุฌูุฉ ูู ูุฑุญูุฉ ุงููุฑุงุฌุนุฉ ููุท
            if (cell.dataset.specialType === 'star-placeholder') {
                cell.textContent = 'โญ'; // ุนุฑุถ ุงููุฌูุฉ
                cell.style.color = '#222'; // ููู ูุต ุงููุฌูุฉ
                cell.style.filter = 'none'; // ุฅุฒุงูุฉ ุฃู ููุชุฑ
                cell.style.textShadow = 'none'; // ุฅุฒุงูุฉ ุฃู ุธู ูุต
                cell.style.backgroundColor = '#ffffff'; // ุฎูููุฉ ุจูุถุงุก ูููุฌูุฉ ุนูุฏ ุงููุดู ูู ุงููุฑุงุฌุนุฉ
                cell.style.fontSize = '45px'; // ุชุทุจูู ุญุฌู ุฎุท ุงูุฅูููุฌู ุนูู ุงููุฌูุฉ
            } else {
                cell.textContent = cell.dataset.content; // ุนุฑุถ ุงููุญุชูู ุงูุฃุตูู (ุงูุฅูููุฌู/ุงููุต/ุงูุนูููุฉ)
                applyCellStyling(cell); // ุชุทุจูู ุงูููุท ุงูููุงุณุจ
            }
        }

        // ุฏุงูุฉ ูุฅุฎูุงุก ูุญุชูู ุงูุฎููุฉ ูุฅุนุงุฏุฉ ุชุนููู ุงูุฃููุงุท
        function hideCell(cell) {
            if (cell.classList.contains('empty') || cell.classList.contains('matched')) return; // ูุง ุชุฎูู ุงูุฎูุงูุง ุงููุทุงุจูุฉ
            cell.classList.add("hidden");
            cell.classList.remove("value-revealed", "negative", "positive"); // ุฅุฒุงูุฉ ูุฆุงุช -1 ู +1
            cell.style.backgroundColor = ''; // ุฅุนุงุฏุฉ ุชุนููู ููู ุงูุฎูููุฉ ุฅูู ุงูููู ุงูุงูุชุฑุงุถู ูููุฎูู
            cell.style.color = 'transparent'; // ุฅุฎูุงุก ููู ุงููุญุชูู
            
            if (cell.dataset.specialType === 'star-placeholder') {
                cell.textContent = ''; // ุฅุฎูุงุก ุงููุต ููุฑุจุน ุงููุฌูุฉ
            } else {
                cell.textContent = cell.dataset.content; // ุฅุนุงุฏุฉ ุงููุญุชูู ุงูุฃุตูู (ุงูุฅูููุฌู/ุงููุต/ุงูุนูููุฉ)
            }
            cell.style.filter = 'none';
            cell.style.textShadow = 'none';
            cell.classList.remove('text-content');
            cell.removeAttribute('data-round-type'); // ุฅุฒุงูุฉ ููุน ุงูุฌููุฉ
            cell.style.fontSize = ''; // ุฅุนุงุฏุฉ ุชุนููู ุญุฌู ุงูุฎุท ุงูุงูุชุฑุงุถู
        }

        // ุฏุงูุฉ ูุชุทุจูู ุงูุฃููุงุท ุงูุจุตุฑูุฉ ุญุณุจ ููุน ุงูุฌููุฉ
        function applyCellStyling(cell) {
            if (cell.classList.contains('empty') || cell.classList.contains('matched') || cell.classList.contains('value-revealed')) {
                return;
            }

            // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃููุงุท ุงูุงูุชุฑุงุถูุฉ ูุจู ุชุทุจูู ุงูุฃููุงุท ุงูุฌุฏูุฏุฉ
            cell.style.color = '#222';
            cell.style.filter = 'none';
            cell.style.textShadow = 'none';
            cell.classList.remove('text-content');
            cell.removeAttribute('data-round-type');
            cell.style.fontSize = ''; // ุฅุนุงุฏุฉ ุชุนููู ุญุฌู ุงูุฎุท ุงูุงูุชุฑุงุถู

            const currentRound = isTieBreakerRound ? null : allGameRounds[currentGroupIndex][roundIndex];

            if (currentRound) {
                if (currentRound.type === "words" || currentRound.type === "letter-word" || currentRound.type === "incomplete-word" || currentRound.type === "math") {
                    cell.classList.add('text-content');
                    cell.setAttribute('data-round-type', currentRound.type);
                } else if (currentRound.type === "emoji") {
                    cell.setAttribute('data-round-type', currentRound.type);
                }
            } else if (isTieBreakerRound) { // For tie-breaker numbers like "505"
                cell.classList.add('text-content');
                cell.setAttribute('data-round-type', 'emoji'); // Use emoji type for styling
            }
        }


        // ุฏุงูุฉ ูุฅูุดุงุก ุงูููุญุฉ ุจูุงุกู ุนูู ุจูุงูุงุช ุงูุฌููุฉ
        function createBoard(roundInfo) {
            console.log("createBoard: Creating new board for round type:", roundInfo.type);
            grid.innerHTML = "";
            grid.className = "grid";

            let items = [];
            let currentGridSizeClass = roundInfo.gridSizeClass;
            let specialSquaresCount = roundInfo.specialSquaresCount;

            if (isTieBreakerRound) {
                const tieBreakerUniqueItems = [...tieBreakerEmojis];
                items = [...tieBreakerUniqueItems, ...tieBreakerUniqueItems];
            } else if (roundInfo.type === "letter-word") {
                roundInfo.letterWordPairs.forEach(pair => {
                    items.push(pair[0], pair[1]);
                });
            } else if (roundInfo.type === "incomplete-word") {
                roundInfo.incompleteWordPairs.forEach(pair => {
                    items.push(pair[1], pair[2]); // ุฅุถุงูุฉ ุงููููุฉ ุงููุงูุตุฉ ูุงูุญุฑู ุงููุงูุต
                });
            } else if (roundInfo.type === "words") {
                roundInfo.textPairs.forEach(pair => {
                    items.push(pair[0], pair[1]);
                });
            } else if (roundInfo.type === "math") {
                roundInfo.mathPairs.forEach(pair => {
                    items.push(pair[0], pair[1]);
                });
            }
            else { // type: "emoji"
                const currentEmojis = [...roundInfo.emojis];
                items = [...currentEmojis, ...currentEmojis];
            }
            
            for (let i = 0; i < specialSquaresCount; i++) {
                items.push("SPECIAL_VALUE_SQUARE");
            }

            shuffle(items);
            grid.classList.add(currentGridSizeClass);

            board = [];
            items.forEach((content, index) => {
                const div = document.createElement("div");
                div.classList.add("cell", "hidden");
                div.dataset.index = index;
                
                if (content === "SPECIAL_VALUE_SQUARE") {
                    div.dataset.content = "SPECIAL_VALUE_SQUARE";
                    div.dataset.specialType = 'star-placeholder';
                    div.textContent = '';
                } else {
                    div.dataset.content = content;
                    div.textContent = content;
                }
                
                grid.appendChild(div);
                board.push(div);
            });

            const totalGridCells = getTotalCellsForGridClass(currentGridSizeClass);
            while (board.length < totalGridCells) {
                const emptyCell = document.createElement("div");
                emptyCell.classList.add("cell", "empty");
                grid.appendChild(emptyCell);
                board.push(emptyCell);
            }
            console.log("createBoard: Total cells created:", board.length);
        }


        function hideAllCards() {
            console.log("hideAllCards: Hiding all game cells.");
            board.forEach(cell => {
                hideCell(cell);
            });
        }

        async function showAllCardsTemporarily() {
            console.log("showAllCardsTemporarily: Revealing cards for review.");
            board.forEach(cell => {
                if (!cell.classList.contains('empty')) {
                    revealCell(cell);
                }
            });

            const currentRound = isTieBreakerRound ? null : allGameRounds[currentGroupIndex][roundIndex];
            let timeLeft = isTieBreakerRound ? tieBreakerTimer : currentRound.timer; // ุงุณุชุฎุฏุงู Timer ุงูุฎุงุต ุจูู ุฌููุฉ
            timerContainer.textContent = `ุงูููุช: ${timeLeft} ุซุงููุฉ`;
            console.log(`showAllCardsTemporarily: Timer set for ${timeLeft} seconds.`);

            await new Promise(resolve => {
                let currentTimerValue = timeLeft;
                timerInterval = setInterval(() => {
                    currentTimerValue--;
                    timerContainer.textContent = `ุงูููุช: ${currentTimerValue} ุซุงููุฉ`;
                    if (currentTimerValue <= 0) { // ุชู ุงูุชุนุฏูู: ูุชููู ุนูุฏ 0
                        clearInterval(timerInterval);
                        timerInterval = null;
                        console.log("showAllCardsTemporarily: Timer finished, hiding cards.");
                        resolve();
                    }
                }, 1000);
            });

            hideAllCards();
            enableClicking(); // ุชูุนูู ุงูููุฑ ุจุนุฏ ุงูุชูุงุก ูุฑุญูุฉ ุงููุดู ุงููุคูุช
            console.log("showAllCardsTemporarily: Clicking enabled.");
        }

        function generateSpecialValue() {
            let value;
            let baseValue;

            if (isTieBreakerRound) {
                baseValue = tieBreakerFixedValue; // ูููุฉ ุซุงุจุชุฉ 4 ูุฌููุฉ ุงูุชุนุงุฏู
                value = (Math.random() > 0.5 ? baseValue : -baseValue); // Fixed +4 or -4
            } else {
                // ูููุฉ ุชุนุชูุฏ ุนูู ุฑูู ุงููุฌููุนุฉ (0 ูููุฌููุนุฉ ุงูุฃูููุ 1 ูููุฌููุนุฉ ุงูุซุงููุฉ)
                baseValue = currentGroupIndex + 1; 
                value = (Math.random() > 0.5 ? baseValue : -baseValue);
            }
            
            console.log(`Generated special value: ${value} (Base: ${baseValue}, Group: ${currentGroupIndex + 1}, TieBreaker: ${isTieBreakerRound})`);
            return value;
        }


        async function startRoundProcess() {
            console.log("startRoundProcess: Entered. isTransitioning (before check):", isTransitioning);
            if (isTransitioning) {
                console.warn("startRoundProcess: Already transitioning. Aborting redundant call.");
                return; // ููุน ุชูุฑุงุฑ ุงูุนุฏุงุฏ ุฅุฐุง ูุงู ููุงู ุงูุชูุงู ุจุงููุนู
            }
            isTransitioning = true;
            console.log("startRoundProcess: Starting new round process. isTransitioning now TRUE.");
            disableControls(); // ุชุนุทูู ุงูุฃุฒุฑุงุฑ ุฃุซูุงุก ุงูุนุฏ ุงูุชูุงุฒูู ูุงููุดู ุงููุคูุช
            startGameBtn.style.display = 'none'; // ุฅุฎูุงุก ุฒุฑ "ุจุฏุก ุงูุฌููุฉ"
            nextGroupBtn.style.display = 'none'; // ุฅุฎูุงุก ุฒุฑ "ุงููุฌููุนุฉ ุงูุชุงููุฉ"
            resetGameBtn.style.display = 'inline-block'; // Ensure reset button is always visible

            let currentRoundInfo = isTieBreakerRound ? null : allGameRounds[currentGroupIndex][roundIndex];
            let categoryText = "";
            if (isTieBreakerRound) {
                categoryText = "ุฌููุฉ ุงูุชุนุงุฏู";
            } else {
                categoryText = `ุฌููุฉ ${currentRoundInfo.category}`;
            }

            // Phase 1: Inter-round countdown
            countdownText.textContent = `ุชุจุฏุฃ ${categoryText} (ุงููุฌููุนุฉ ${currentGroupIndex + 1}) ุจุนุฏ:`;
            countdownOverlay.classList.add("show");
            console.log(`startRoundProcess: Showing inter-round countdown for ${categoryText}.`);

            let countdown = interRoundDelay;
            countdownNumber.textContent = countdown;

            await new Promise(resolve => {
                const interval = setInterval(() => {
                    countdown--;
                    countdownNumber.textContent = countdown;
                    if (countdown <= 0) { // ุชู ุงูุชุนุฏูู: ูุชููู ุนูุฏ 0
                        clearInterval(interval);
                        countdownOverlay.classList.remove("show");
                        console.log("startRoundProcess: Inter-round countdown finished.");
                        resolve();
                    }
                }, 1000);
            });
            
            // Phase 2: Board creation and temporary reveal
            const roundToCreate = isTieBreakerRound ? { gridSizeClass: "size-15", specialSquaresCount: tieBreakerSpecialSquaresCount, type: "emoji" } : currentRoundInfo;
            createBoard(roundToCreate);
            hideAllCards(); // Hide cards initially after creation

            updateActiveTeamDisplay();
            await showAllCardsTemporarily(); // This includes the timer for revealing cards

            // Phase 3: Cleanup and re-enabling controls
            isTransitioning = false; // Reset ONLY here, after all transitions are done
            enableControls();
            console.log("startRoundProcess: Round preparation complete. isTransitioning set to FALSE. Controls enabled.");
        }


        async function handleClick(event) {
            console.log("handleClick: Event triggered. lockBoard:", lockBoard, "isTransitioning:", isTransitioning);
            if (lockBoard) {
                console.log("handleClick: Board is locked. Ignoring click.");
                return;
            }
            const clickedCell = event.target;
            if (clickedCell === firstPick || clickedCell.classList.contains('matched') || clickedCell.classList.contains('empty')) {
                console.log("handleClick: Invalid click (same cell, matched, or empty). Ignoring.");
                return;
            }

            console.log(`handleClick: Cell ${clickedCell.dataset.index} with content ${clickedCell.dataset.content} clicked.`);

            // ุงูุชุนุงูู ูุน ูุฑุจุน ุงููุฌูุฉ (SPECIAL_VALUE_SQUARE)
            if (clickedCell.dataset.content === "SPECIAL_VALUE_SQUARE") {
                lockBoard = true;
                
                const value = generateSpecialValue();
                scores[activeTeams[currentTeamIndex]] += value;
                updateScoreboard();

                clickedCell.textContent = (value > 0 ? "+" : "") + value; // ุนุฑุถ ุงููููุฉ
                clickedCell.classList.add('value-revealed', value > 0 ? 'positive' : 'negative'); // ุชุทุจูู ุงูุฃููุงู
                
                console.log(`Special Square: ${value} points for ${teamNames[activeTeams[currentTeamIndex]]}. New score: ${scores[activeTeams[currentTeamIndex]]}`);
                
                if (firstPick && firstPick !== clickedCell) {
                    hideCell(firstPick);
                }

                setTimeout(() => {
                    hideCell(clickedCell);
                    resetBoard();
                    moveToNextTeam(); // ุงูุงูุชูุงู ูููุฑูู ุงูุชุงูู ุจุนุฏ ูุดู ุงููุฌูุฉ
                }, 1200);

                return;
            }

            // ูุฐุง ุงูุฌุฒุก ูููุฑุจุนุงุช ุงูุนุงุฏูุฉ ููุท
            revealCell(clickedCell);

            if (!firstPick) {
                firstPick = clickedCell;
                console.log(`First pick: ${firstPick.dataset.content}`);
                return;
            }

            lockBoard = true;
            console.log(`Second pick: ${clickedCell.dataset.content}`);

            const currentRound = isTieBreakerRound ? null : allGameRounds[currentGroupIndex][roundIndex];

            let isMatch = false;
            const firstContent = firstPick.dataset.content;
            const secondContent = clickedCell.dataset.content;

            if (currentRound && currentRound.type === "words") {
                const pairFound = currentRound.textPairs.find(pair =>
                    (pair[0] === firstContent && pair[1] === secondContent) ||
                    (pair[1] === firstContent && pair[0] === secondContent)
                );
                isMatch = !!pairFound;
            } else if (currentRound && currentRound.type === "letter-word") {
                const pairFound = currentRound.letterWordPairs.find(pair =>
                    (pair[0] === firstContent && pair[1] === secondContent) ||
                    (pair[1] === firstContent && pair[0] === secondContent)
                );
                isMatch = !!pairFound;
            } else if (currentRound && currentRound.type === "incomplete-word") {
                const pairFound = currentRound.incompleteWordPairs.find(pair =>
                    (pair[1] === firstContent && pair[2] === secondContent) || // ุงููููุฉ ุงููุงูุตุฉ + ุงูุญุฑู ุงููุงูุต
                    (pair[2] === firstContent && pair[1] === secondContent)    // ุงูุญุฑู ุงููุงูุต + ุงููููุฉ ุงููุงูุตุฉ
                );
                isMatch = !!pairFound;
            } else if (currentRound && currentRound.type === "math") {
                const pairFound = currentRound.mathPairs.find(pair =>
                    (pair[0] === firstContent && pair[1] === secondContent) ||
                    (pair[1] === firstContent && pair[0] === secondContent)
                );
                isMatch = !!pairFound;
            }
            else { // type: "emoji" (or tie breaker)
                isMatch = (secondContent === firstContent);
            }


            if (isMatch) {
                // Match
                scores[activeTeams[currentTeamIndex]] += 1;
                updateScoreboard();
                firstPick.classList.add('matched');
                clickedCell.classList.add('matched');
                matchedPairsCount++; // ุฒูุงุฏุฉ ููุท ููุฃุฒูุงุฌ ุงูุนุงุฏูุฉ
                console.log("Match found! Current matched pairs:", matchedPairsCount);
                
                resetBoard(); // ุชู ุฅุนุงุฏุฉ ุชุนููู firstPick ู lockBoard ููุง

                // ุชุฃุฎูุฑ ุจุณูุท ููุณูุงุญ ูููุณุชุฎุฏู ุจุฑุคูุฉ ุงููุทุงุจูุฉ ูุจู ุงูุชูุงู ุงูุฏูุฑ
                setTimeout(() => {
                    moveToNextTeam(); // ุงูุงูุชูุงู ูููุฑูู ุงูุชุงูู ุจุบุถ ุงููุธุฑ ุนู ุงููุทุงุจูุฉ
                    checkGameEnd(); // ุงูุชุญูู ูู ุงูุชูุงุก ุงูุฌููุฉ (ุจูุงุกู ุนูู ุงูุฃุฒูุงุฌ ุงูุนุงุฏูุฉ)
                }, 500); // 0.5 ุซุงููุฉ ุชุฃุฎูุฑ
            } else {
                // No Match
                console.log("No match.");
                setTimeout(() => {
                    hideCell(firstPick);
                    hideCell(clickedCell);
                    resetBoard();
                    moveToNextTeam(); // ุงูุงูุชูุงู ูููุฑูู ุงูุชุงูู
                }, 1000);
            }
        }

        function resetBoard() {
            firstPick = null;
            lockBoard = false;
        }

        function updateScoreboard() {
            activeTeams.forEach(team => {
                const scoreSpan = document.getElementById(`score${team.charAt(0).toUpperCase() + team.slice(1)}`);
                if (scoreSpan) {
                    scoreSpan.textContent = scores[team];
                }
                scoreBoardElements[team].classList.remove('active');
            });
            updateActiveTeamDisplay();
        }

        function updateActiveTeamDisplay() {
            if (scoreBoardElements[activeTeams[currentTeamIndex]]) {
                scoreBoardElements[activeTeams[currentTeamIndex]].classList.add('active');
                resultDisplay.textContent = `ุฏูุฑ ูุฑูู: ${teamNames[activeTeams[currentTeamIndex]]}`;
            }
        }

        function moveToNextTeam() {
            currentTeamIndex = (currentTeamIndex + 1) % activeTeams.length;
            updateActiveTeamDisplay();
        }

        async function checkGameEnd() {
            console.log("checkGameEnd: Entered. matchedPairsCount:", matchedPairsCount);
            let totalPairsToMatch; // ุนุฏุฏ ุงูุฃุฒูุงุฌ ุงูุนุงุฏูุฉ ุงูุชู ูุฌุจ ูุทุงุจูุชูุง

            if (isTieBreakerRound) {
                totalPairsToMatch = tieBreakerTotalEmojiPairs;
            } else {
                totalPairsToMatch = allGameRounds[currentGroupIndex][roundIndex].totalEmojiPairs;
            }
            
            // ุดุฑุท ุงูุชูุงุก ุงูุฌููุฉ: ุนุฏุฏ ุงูุฃุฒูุงุฌ ุงูุนุงุฏูุฉ ุงููุทุงุจูุฉ ูุฌุจ ุฃู ูุณุงูู ุงูุฅุฌูุงูู
            if (matchedPairsCount >= totalPairsToMatch) {
                console.log("checkGameEnd: Round finished! All pairs matched.");
                timerContainer.textContent = "ุงูุชูุช ุงูุฌููุฉ!";
                disableClicking();
                disableControls(); // Disable controls immediately when round ends
                
                if (isTieBreakerRound) {
                    console.log("checkGameEnd: Tie-breaker round complete. Ending game.");
                    endGame(true); // ุฅุฐุง ูุงูุช ุฌููุฉ ุชุนุงุฏูุ ูููู ุงููุนุจุฉ ููุญุฏุฏ ุงููุงุฆุฒ
                    return;
                }

                roundIndex++; // ุงูุชูุฏู ููุฌููุฉ ุงูุชุงููุฉ
                matchedPairsCount = 0; // ุฅุนุงุฏุฉ ุชุนููู ูุนุฏุงุฏ ุงูุฃุฒูุงุฌ ููุฌููุฉ ุงูุฌุฏูุฏุฉ
                startingTeamIndexForRound = currentTeamIndex; // ุงููุฑูู ุงูุญุงูู ูุจุฏุฃ ุงูุฌููุฉ ุงูุชุงููุฉ

                if (roundIndex < allGameRounds[currentGroupIndex].length) {
                    // ูุง ูุฒุงู ููุงู ุฌููุงุช ูู ุงููุฌููุนุฉ ุงูุญุงููุฉ
                    let nextRoundCategory = allGameRounds[currentGroupIndex][roundIndex].category;
                    console.log(`checkGameEnd: Moving to next round in current group: ${nextRoundCategory}`);
                    startRoundProcess(); // ุงุจุฏุฃ ุงูุฌููุฉ ุงูุชุงููุฉ ุชููุงุฆููุง
                } else {
                    // ุงูุชูุช ุฌููุน ุฌููุงุช ุงููุฌููุนุฉ ุงูุญุงููุฉ
                    console.log("checkGameEnd: All rounds in current group finished. Ending group.");
                    endGroup(); // ุณูุชู ุงูุชุนุงูู ูุน ุงูุงูุชูุงู ูููุฌููุนุฉ ุงูุชุงููุฉ ุฃู ุฅููุงุก ุงููุนุจุฉ
                }
            } else {
                console.log("checkGameEnd: Round not finished. Remaining pairs:", totalPairsToMatch - matchedPairsCount);
            }
        }

        // showInterRoundCountdown function is no longer needed as a separate public function.
        // Its logic has been moved into startRoundProcess.


        async function endGroup() {
            console.log("endGroup: Group finished! Checking for next group or final winner.");
            
            currentGroupIndex++; // ุงูุชูุฏู ูููุฌููุนุฉ ุงูุชุงููุฉ
            roundIndex = 0; // ุฅุนุงุฏุฉ ุชุนููู ูุคุดุฑ ุงูุฌููุงุช ูุฃูู ุฌููุฉ ูู ุงููุฌููุนุฉ ุงูุฌุฏูุฏุฉ

            if (currentGroupIndex < allGameRounds.length) {
                // ูุง ูุฒุงู ููุงู ูุฌููุนุงุช ุชุงููุฉุ ุนุฑุถ ุฒุฑ "ุงููุฌููุนุฉ ุงูุชุงููุฉ"
                resultDisplay.textContent = "ุงูุชูุช ุงููุฌููุนุฉ! ุงุถุบุท ุนูู 'ุงููุฌููุนุฉ ุงูุชุงููุฉ'";
                startGameBtn.style.display = 'none';
                nextGroupBtn.style.display = 'inline-block';
                enableControls(); // ุชูููู ุงูุฒุฑ
            } else {
                // ุงูุชูุช ุฌููุน ุงููุฌููุนุงุชุ ุฅุธูุงุฑ ุงููุงุฆุฒ ุงูููุงุฆู
                console.log("endGroup: All groups finished. Determining final winner.");
                endGame(false); // ููุณ ุฌููุฉ ุชุนุงุฏู ูู ูุฐู ุงููุฑุญูุฉ
            }
        }

        function nextGroupManually() {
            console.log("nextGroupManually: Button clicked.");
            disableControls(); // ุชุนุทูู ุงูุฃุฒุฑุงุฑ ูุคูุชุง
            nextGroupBtn.style.display = 'none'; // ุฅุฎูุงุก ุงูุฒุฑ
            startGameBtn.textContent = "ุจุฏุก ุงูุฌููุฉ"; // ุฅุนุงุฏุฉ ุชุนููู ูุต ุฒุฑ ุงูุจุฏุก
            startGameBtn.style.display = 'inline-block'; // ุฅุธูุงุฑ ุฒุฑ ุจุฏุก ุงูุฌููุฉ ูููุฌููุนุฉ ุงูุฌุฏูุฏุฉ

            // ูุจุฏุฃ ุนูููุฉ ุงูุฌููุฉ ุงูุฌุฏูุฏุฉ ูุจุงุดุฑุฉ
            startRoundProcess();
        }


        function endGame(fromTieBreaker = false) {
            console.log("endGame: Called. fromTieBreaker:", fromTieBreaker);
            let maxScore = -Infinity;
            let winners = [];
            
            // Log current scores for debugging
            console.log("Current scores:", scores);

            activeTeams.forEach(team => {
                if (scores[team] > maxScore) {
                    maxScore = scores[team];
                    winners = [team];
                } else if (scores[team] === maxScore) {
                    winners.push(team);
                }
            });

            console.log("endGame: Winner candidates:", winners.map(t => teamNames[t]), "Max Score:", maxScore);

            hideAllModals(); // ุฅุฎูุงุก ุฃู ููุฏุงู ููุชูุญ
            gameArea.style.display = 'none'; // ุฅุฎูุงุก ููุทูุฉ ุงููุนุจ

            if (winners.length === 1) {
                finalWinnerText.textContent = `ูุงุฒ ุงููุฑูู: ${teamNames[winners[0]]} ๐ ุชูุงูููุง!`;
                finalWinnerText.style.color = teamCssColors[winners[0]]; // Set color to winning team's color
                finalTieText.textContent = "";
                startTieBreakerBtn.style.display = 'none'; // Hide tie breaker button
                playAgainBtn.textContent = `ุฅุนุงุฏุฉ ุชุนููู ูุจุฏุก ูุนุจุฉ ุฌุฏูุฏุฉ`; // Ensure text is clear for reset
                playAgainBtn.style.display = 'inline-block'; // Show play again button
                triggerConfetti(); // ุฅุทูุงู ุงููุตุงุตุงุช
                console.log(`endGame: Single winner: ${teamNames[winners[0]]}`);
            } else {
                finalWinnerText.textContent = `ุชุนุงุฏู ููุงุฆู ุจูู:`;
                finalWinnerText.style.color = "#ffd700"; // Keep golden for tie message header
                finalTieText.textContent = `${winners.map(t => teamNames[t]).join(', ')} ๐ค`;
                console.log("endGame: Tie detected between:", winners.map(t => teamNames[t]));

                if (!fromTieBreaker) {
                    finalTieText.textContent += ` - ุฌููุฉ ุชุนุงุฏู!`;
                    finalTieText.style.color = ""; // Reset to default
                    isTieBreakerRound = true; // ุชูุนูู ุฌููุฉ ุงูุชุนุงุฏู
                    startTieBreakerBtn.style.display = 'inline-block'; // Show tie breaker button
                    playAgainBtn.style.display = 'none'; // Hide play again button temporarily
                    console.log("endGame: Initiating tie-breaker setup.");
                } else {
                    // It was a tie-breaker, and it's still a tie (or finished with no clear single winner)
                    finalTieText.textContent += ` (ุชุนุงุฏู)`; // Indicate it's a tie even after tie-breaker
                    finalTieText.style.color = '#888'; // Set to gray for tie-breaker tie
                    startTieBreakerBtn.style.display = 'none'; // Hide tie breaker button
                    playAgainBtn.textContent = `ุฅุนุงุฏุฉ ุชุนููู ูุจุฏุก ูุนุจุฉ ุฌุฏูุฏุฉ`; // Ensure text is clear for reset
                    playAgainBtn.style.display = 'inline-block'; // Show play again button
                    console.log("endGame: Tie-breaker ended in another tie or final decision. Showing reset.");
                }
            }
            finalWinnerModal.classList.add('show'); // ุนุฑุถ ูุงูุฐุฉ ุงูููุฒ (ุงูุขู ุณุชุธูุฑ ุจุดูู ุตุญูุญ ุจุณุจุจ ุชุนุฏููุงุช CSS)
        }

        // --- ูุธุงุฆู ุงููุตุงุตุงุช (Confetti) ---
        function triggerConfetti() {
            const numConfetti = 100; // ุนุฏุฏ ุงููุตุงุตุงุช
            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`; // ุจูู 2 ู 5 ุซูุงูู
                document.body.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        function clearConfetti() {
            const existingConfetti = document.querySelectorAll('.confetti');
            existingConfetti.forEach(c => c.remove());
        }

        // --- Reset Confirmation Logic ---
        function showResetConfirmation() {
            hideAllModals(); // Hide any other open modals
            resetConfirmationModal.classList.add('show');
            console.log("Showing reset confirmation modal.");
        }

        confirmResetBtn.addEventListener('click', () => {
            hideAllModals(); // Hide confirmation modal
            resetGame(true); // Proceed with full reset
        });

        cancelResetBtn.addEventListener('click', () => {
            hideAllModals(); // Just hide the confirmation modal
            // Optionally, re-enable game area if it was visible before
            if (gameInitialized && !finalWinnerModal.classList.contains('show')) {
                gameArea.style.display = 'flex';
            }
            console.log("Reset cancelled.");
        });


        function resetGame(fullReset = false) {
            console.log("resetGame: Resetting game (fullReset:", fullReset, ")");
            clearInterval(timerInterval);
            timerInterval = null;
            firstPick = null;
            lockBoard = false;
            matchedPairsCount = 0;
            currentTeamIndex = 0;
            startingTeamIndexForRound = 0;
            currentGroupIndex = 0;
            roundIndex = 0;
            isTieBreakerRound = false;
            resultDisplay.textContent = "";
            timerContainer.textContent = "";
            grid.innerHTML = "";
            grid.className = "grid";
            gameInitialized = false;
            isTransitioning = false; // ุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุงูุงูุชูุงู

            // ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุท ุจุงููุงูู ุนูุฏ "ุฅุนุงุฏุฉ ุชุนููู" ูู ุฒุฑ ุงููุนุจุฉ ุฃู "ุงูุนุจ ูุฑุฉ ุฃุฎุฑู" ูู ุดุงุดุฉ ุงูููุฒ
            if (fullReset) {
                activeTeams.forEach(team => {
                    scores[team] = 0;
                });
            }
            updateScoreboard(); // ูุชุญุฏูุซ ุนุฑุถ ุงูููุงุท (ุงูุขู ูู ุชุฑุงูููุฉ)

            // Reset team names to default when full reset
            teamNames = {
                "blue": "ุงููุฑูู ุงูุฃุฒุฑู",
                "red": "ุงููุฑูู ุงูุฃุญูุฑ",
                "green": "ุงููุฑูู ุงูุฃุฎุถุฑ",
                "orange": "ุงููุฑูู ุงูุจุฑุชูุงูู"
            };

            hideAllModals(); // ุฅุฎูุงุก ุฌููุน ุงูููุฏุงูุงุช ุงูุญุงููุฉ (ุงูุขู ุณุชุนูู ุจุดูู ุตุญูุญ)
            showTeamSelectionModal(); // ุงูุนูุฏุฉ ูุดุงุดุฉ ุงุฎุชูุงุฑ ุงููุฑู
            console.log("Game reset complete. Showing team selection modal.");
        }

        function disableClicking() {
            board.forEach(cell => {
                cell.removeEventListener('click', handleClick);
            });
            console.log("Clicking disabled.");
        }

        function enableClicking() {
            board.forEach(cell => {
                if (!cell.classList.contains('matched') && !cell.classList.contains('empty')) {
                    cell.addEventListener('click', handleClick);
                }
            });
            console.log("Clicking enabled.");
        }

        function disableControls() {
            startGameBtn.disabled = true;
            nextGroupBtn.disabled = true;
            resetGameBtn.disabled = true;
            console.log("Controls disabled.");
        }

        function enableControls() {
            startGameBtn.disabled = false;
            nextGroupBtn.disabled = false;
            resetGameBtn.disabled = false;
            console.log("Controls enabled.");
        }

        async function handleStartOrNextRound() {
            console.log("handleStartOrNextRound: Called. gameInitialized:", gameInitialized, "isTieBreakerRound:", isTieBreakerRound, "isTransitioning (before call):", isTransitioning);
            if (isTransitioning) {
                console.warn("handleStartOrNextRound: Transition is active, ignoring click.");
                return;
            }

            if (gameInitialized || isTieBreakerRound) {
                matchedPairsCount = 0;
                await startRoundProcess();
            } else {
                console.log("Game not initialized. Please select teams first.");
            }
        }

        // ุฑุจุท ุฒุฑ "ุงูุนุจ ูุฑุฉ ุฃุฎุฑู" ูู ูุงูุฐุฉ ุงูููุฒ ุจูุธููุฉ ุฅุนุงุฏุฉ ุงูุชุนููู ุงููุงููุฉ
        playAgainBtn.addEventListener('click', () => resetGame(true));
        // ุฑุจุท ุฒุฑ "ุจุฏุก ุฌููุฉ ุงูุชุนุงุฏู" ูู ูุงูุฐุฉ ุงูููุฒ
        startTieBreakerBtn.addEventListener('click', async () => {
            console.log("Start Tie-Breaker button clicked.");
            finalWinnerModal.classList.remove('show'); // ุฅุฎูุงุก ูุงูุฐุฉ ุงูููุฒ
            gameArea.style.display = 'flex'; // ุฅุนุงุฏุฉ ุฅุธูุงุฑ ููุทูุฉ ุงููุนุจ
            isTieBreakerRound = true; // This might be redundant if set in endGame, but ensures it.
            await startRoundProcess(); // ุจุฏุก ุฌููุฉ ุงูุชุนุงุฏู
        });


        // ุจุฏุก ุงููุนุจุฉ ุนูุฏ ุงูุชุญููู
        document.addEventListener('DOMContentLoaded', showWelcomeModal);
    </script>
</body>
</html>
